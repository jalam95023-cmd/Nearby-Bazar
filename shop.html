<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partner App - Nearby Bazar</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { background-color: #0f0f0f; color: white; font-family: sans-serif; padding-bottom: 80px; }
        
        /* Screens */
        .screen { display: none; min-height: 100vh; padding: 20px; }
        .screen.active { display: flex; flex-direction: column; }
        
        /* Inputs & Buttons */
        input { background: #1a1a1a; border: 1px solid #333; color: white; padding: 15px; width: 100%; border-radius: 12px; margin-bottom: 12px; outline: none; font-size: 16px; }
        .btn-primary { background: linear-gradient(to right, #ea580c, #c2410c); color: white; padding: 15px; border-radius: 12px; font-weight: bold; width: 100%; font-size: 16px; box-shadow: 0 4px 15px rgba(234, 88, 12, 0.4); text-align: center; }
        
        /* Dashboard Cards */
        .aesthetic-card { background: #1a1a1a; border: 1px solid #333; border-radius: 16px; padding: 16px; margin-bottom: 12px; }
        .status-pill { padding: 4px 12px; border-radius: 99px; font-size: 10px; font-weight: bold; text-transform: uppercase; display: inline-block; }
        
        /* Animations */
        .pulse-ring { width: 80px; height: 80px; border-radius: 50%; border: 4px solid #F97316; animation: ring 2s infinite; margin: 0 auto 20px auto; display: flex; align-items: center; justify-content: center; }
        @keyframes ring { 0% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(249, 115, 22, 0); } 100% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0); } }
    </style>
</head>
<body>

    <div id="screen-auth" class="screen active justify-center">
        <div class="text-center mb-10">
            <h1 class="text-4xl font-bold text-orange-500 mb-2">Nearby Bazar</h1>
            <p class="text-gray-500 text-sm tracking-widest uppercase">Partner Login</p>
        </div>

        <div id="form-login">
            <input type="text" id="login-id" placeholder="Shop Username (e.g. sgmc123)">
            <input type="password" id="login-pass" placeholder="Password">
            <button onclick="handleLogin()" id="btn-login" class="btn-primary mb-4">Login Securely</button>
            <p class="text-center text-gray-500 text-sm mt-4">New Shop? <span onclick="switchForm('register')" class="text-orange-400 font-bold cursor-pointer">Register Here</span></p>
        </div>

        <div id="form-register" style="display:none;">
            <input type="text" id="reg-name" placeholder="Shop Name">
            <input type="text" id="reg-owner" placeholder="Owner Name">
            <input type="tel" id="reg-phone" placeholder="Mobile Number">
            <input type="text" id="reg-id" placeholder="Create Shop ID (Unique)">
            <input type="password" id="reg-pass" placeholder="Create Password">
            <input type="text" id="reg-upi" placeholder="UPI ID">
            <button onclick="handleRegister()" id="btn-reg" class="btn-primary mb-4">Submit Application</button>
            <p class="text-center text-gray-500 text-sm mt-4">Already have ID? <span onclick="switchForm('login')" class="text-orange-400 font-bold cursor-pointer">Login Here</span></p>
        </div>
    </div>

    <div id="screen-pending" class="screen justify-center text-center">
        <div class="pulse-ring"><i class="fas fa-hourglass-half text-3xl text-orange-500"></i></div>
        <h2 class="text-2xl font-bold text-white mb-2">Verification Pending</h2>
        <p class="text-gray-400 text-sm mb-8 px-4">Your shop <span id="pending-name" class="text-orange-400 font-bold"></span> is under review. Please wait for Superadmin approval.</p>
        <button onclick="logout()" class="text-gray-500 text-xs underline">Logout / Refresh</button>
    </div>

    <div id="screen-dashboard" class="screen">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl font-bold text-orange-500" id="dash-name">My Shop</h1>
                <p class="text-[10px] text-green-500 font-bold uppercase tracking-wider">● LIVE ONLINE</p>
            </div>
            <button onclick="logout()" class="w-10 h-10 rounded-full bg-gray-800 text-white flex items-center justify-center border border-gray-700">
                <i class="fas fa-power-off"></i>
            </button>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="aesthetic-card text-center !mb-0">
                <span class="text-xs uppercase text-gray-500">Revenue</span>
                <h2 class="text-2xl font-bold text-green-500 mt-1">₹<span id="stat-sales">0</span></h2>
            </div>
            <div class="aesthetic-card text-center !mb-0">
                <span class="text-xs uppercase text-gray-500">Orders</span>
                <h2 class="text-3xl font-bold text-yellow-500 mt-1" id="stat-count">0</h2>
            </div>
        </div>

        <div class="flex justify-between items-center mb-4 border-b border-gray-800 pb-2">
            <h3 class="font-bold text-lg">Active Orders</h3>
            <div class="flex items-center gap-2">
                <span id="sound-indicator" class="text-xs text-gray-500"><i class="fas fa-volume-up"></i> ON</span>
                <button onclick="toggleShopStatus()" id="status-btn" class="text-[10px] font-bold px-3 py-1 rounded bg-green-600 text-white">OPEN</button>
            </div>
        </div>

        <div id="orders-list" class="space-y-3 pb-20">
            <p class="text-center text-gray-600 mt-10 text-sm">Waiting for orders...</p>
        </div>
        
        <button onclick="openInventory()" class="fixed bottom-6 right-6 w-14 h-14 bg-orange-600 rounded-full text-white shadow-2xl flex items-center justify-center text-xl z-20">
            <i class="fas fa-box"></i>
        </button>
    </div>

    <div id="modal-inventory" class="fixed inset-0 bg-black z-50 hidden flex flex-col p-4">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-white">Inventory</h2>
            <button onclick="document.getElementById('modal-inventory').style.display='none'" class="text-gray-400 text-xl"><i class="fas fa-times"></i></button>
        </div>
        <div id="inventory-list" class="flex-1 overflow-y-auto space-y-3"></div>
        <button onclick="addItem()" class="w-full bg-orange-600 text-white py-4 rounded-xl font-bold mt-4 shadow-lg sticky bottom-0">Add New Product</button>
    </div>

    <audio id="alert-sound" src="https://assets.mixkit.co/active_storage/sfx/2865/2865-preview.mp3" loop></audio>

    <script>
        // --- CONFIGURATION ---
        const firebaseConfig = { 
            apiKey: "AIzaSyDm_yS9tmdfnMmhoUiGwLSAnQpz5trXuko", 
            authDomain: "nearby-bazar.firebaseapp.com", 
            projectId: "nearby-bazar", 
            storageBucket: "nearby-bazar.firebasestorage.app", 
            messagingSenderId: "183262510084", 
            appId: "1:183262510084:web:909fa3aac2f2429a7d8951" 
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let SHOP_ID = localStorage.getItem('nb_shop_id');
        let soundEnabled = true;
        let isRinging = false;
        const audio = document.getElementById('alert-sound');

        // --- APP STARTUP ---
        function init() {
            if(SHOP_ID) {
                // Agar pehle se login hai, direct listener start karo
                startShopListener();
            } else {
                showScreen('auth');
            }
        }

        // --- AUTH FUNCTIONS ---
        function handleLogin() {
            const id = document.getElementById('login-id').value.trim().toLowerCase();
            const pass = document.getElementById('login-pass').value.trim();
            const btn = document.getElementById('btn-login');

            if(!id || !pass) return Swal.fire("Error", "ID aur Password daalo", "warning");

            btn.innerText = "Checking...";
            btn.disabled = true;

            db.collection('shops').doc(id).get().then(doc => {
                btn.disabled = false;
                btn.innerText = "Login Securely";

                if(doc.exists) {
                    const data = doc.data();
                    if(data.password === pass) {
                        localStorage.setItem('nb_shop_id', id);
                        SHOP_ID = id;
                        startShopListener(); // Redirect Logic Here
                    } else {
                        Swal.fire("Error", "Galat Password!", "error");
                    }
                } else {
                    Swal.fire("Error", "Ye Shop ID exist nahi karti", "error");
                }
            }).catch(e => {
                btn.disabled = false;
                btn.innerText = "Login Securely";
                Swal.fire("Network Error", e.message, "error");
            });
        }

        function handleRegister() {
            const id = document.getElementById('reg-id').value.trim().toLowerCase().replace(/\s/g,'');
            const name = document.getElementById('reg-name').value;
            const btn = document.getElementById('btn-reg');

            if(!id || !name) return Swal.fire("Error", "Details bharo", "warning");

            btn.innerText = "Processing...";
            btn.disabled = true;

            // Location Fix (Default 0,0 if fails)
            let lat = 0, lng = 0;
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (p) => { registerProcess(id, name, p.coords.latitude, p.coords.longitude); },
                    (e) => { registerProcess(id, name, 0, 0); } // Error fallback
                );
            } else {
                registerProcess(id, name, 0, 0);
            }
        }

        function registerProcess(id, name, lat, lng) {
            const data = {
                shopId: id,
                shopName: name,
                ownerName: document.getElementById('reg-owner').value,
                phone: document.getElementById('reg-phone').value,
                password: document.getElementById('reg-pass').value,
                upiId: document.getElementById('reg-upi').value,
                status: 'pending',
                isOpen: false,
                location: { lat, lng },
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            db.collection('shops').doc(id).set(data).then(() => {
                // Empty Inventory Create
                db.collection('shops').doc(id).collection('menu').doc('items').set({customItems:[]});
                
                Swal.fire("Success", "Request Sent! Login karke status check karo.", "success");
                switchForm('login');
                document.getElementById('btn-reg').innerText = "Submit Application";
                document.getElementById('btn-reg').disabled = false;
            }).catch(e => {
                Swal.fire("Error", e.message, "error");
                document.getElementById('btn-reg').innerText = "Submit Application";
                document.getElementById('btn-reg').disabled = false;
            });
        }

        // --- CORE LISTENER (AUTO REDIRECT) ---
        function startShopListener() {
            // Screen update based on status
            db.collection('shops').doc(SHOP_ID).onSnapshot(doc => {
                if(!doc.exists) {
                    localStorage.removeItem('nb_shop_id');
                    location.reload();
                    return;
                }

                const s = doc.data();
                
                // 1. Check Status
                if(s.status === 'pending') {
                    showScreen('pending');
                    document.getElementById('pending-name').innerText = s.shopName;
                } else if(s.status === 'suspended') {
                    Swal.fire("Blocked", "Dukan Suspend kar di gayi hai.", "error").then(logout);
                } else if(s.status === 'verified') {
                    showScreen('dashboard');
                    document.getElementById('dash-name').innerText = s.shopName;
                    updateStatusUI(s.isOpen);
                    loadOrders(); // Load Orders if verified
                }
            });
        }

        function loadOrders() {
            db.collection('orders').where('shopId', '==', SHOP_ID)
              .orderBy('timestamp', 'desc')
              .onSnapshot(snap => {
                  const list = document.getElementById('orders-list');
                  let html = "";
                  let active = 0, sales = 0;
                  let shouldRing = false;

                  snap.forEach(doc => {
                      const d = doc.data();
                      const id = doc.id;

                      if(d.status === 'completed') sales += parseInt(d.totalAmount) || 0;
                      
                      if(d.status !== 'completed' && d.status !== 'rejected') {
                          active++;
                          if(d.status === 'pending') shouldRing = true;

                          const items = d.items.map(i => `${i.qty} x ${i.name}`).join(', ');
                          
                          html += `
                          <div class="aesthetic-card border-l-4 ${d.status==='pending'?'border-yellow-500':d.status==='cooking'?'border-blue-500':'border-green-500'}">
                              <div class="flex justify-between mb-2">
                                  <h3 class="font-bold text-lg">${d.customerName}</h3>
                                  <span class="status-pill bg-gray-800">${d.status}</span>
                              </div>
                              <p class="text-sm text-gray-400 mb-2">${items}</p>
                              <div class="flex justify-between items-center mt-3">
                                  <span class="font-bold text-orange-500 text-xl">₹${d.totalAmount}</span>
                                  <div class="flex gap-2">
                                      ${getActions(id, d.status)}
                                  </div>
                              </div>
                          </div>`;
                      }
                  });

                  list.innerHTML = html || "<p class='text-center text-gray-500 mt-10'>No Active Orders</p>";
                  document.getElementById('stat-count').innerText = active;
                  document.getElementById('stat-sales').innerText = sales;

                  if(shouldRing && !isRinging) { audio.play(); isRinging = true; }
                  if(!shouldRing && isRinging) { audio.pause(); audio.currentTime=0; isRinging = false; }
              });
        }

        function getActions(id, status) {
            if(status === 'pending') return `<button onclick="updOrder('${id}','cooking')" class="bg-blue-600 px-3 py-1 rounded text-xs font-bold">Accept</button><button onclick="updOrder('${id}','rejected')" class="bg-red-600 px-3 py-1 rounded text-xs font-bold">Reject</button>`;
            if(status === 'cooking') return `<button onclick="updOrder('${id}','ready')" class="bg-yellow-600 text-black px-3 py-1 rounded text-xs font-bold">Ready</button>`;
            if(status === 'ready') return `<button onclick="updOrder('${id}','completed')" class="bg-green-600 px-3 py-1 rounded text-xs font-bold">Done</button>`;
            return "";
        }

        // --- UTILS ---
        window.updOrder = (id, st) => db.collection('orders').doc(id).update({status: st});
        
        window.toggleShopStatus = () => {
            const btn = document.getElementById('status-btn');
            const current = btn.innerText === "OPEN";
            db.collection('shops').doc(SHOP_ID).update({isOpen: !current});
        };

        function updateStatusUI(isOpen) {
            const btn = document.getElementById('status-btn');
            btn.innerText = isOpen ? "OPEN" : "CLOSED";
            btn.className = isOpen ? "text-[10px] font-bold px-3 py-1 rounded bg-green-600 text-white" : "text-[10px] font-bold px-3 py-1 rounded bg-red-600 text-white";
        }

        // Inventory
        window.openInventory = () => {
            document.getElementById('modal-inventory').style.display = 'flex';
            db.collection('shops').doc(SHOP_ID).collection('menu').doc('items').onSnapshot(doc => {
                const items = doc.exists ? doc.data().customItems || [] : [];
                document.getElementById('inventory-list').innerHTML = items.map((i, idx) => `
                    <div class="aesthetic-card flex justify-between items-center p-3 mb-2">
                        <div><p class="font-bold">${i.name}</p><p class="text-xs text-gray-400">₹${i.price}</p></div>
                        <button onclick="delItem(${idx})" class="text-red-500"><i class="fas fa-trash"></i></button>
                    </div>
                `).join('');
            });
        };

        window.addItem = async () => {
            const { value: form } = await Swal.fire({
                title: 'New Item',
                html: '<input id="sw-name" placeholder="Name" class="swal2-input"><input id="sw-price" type="number" placeholder="Price" class="swal2-input">',
                preConfirm: () => [document.getElementById('sw-name').value, document.getElementById('sw-price').value]
            });
            if(form && form[0]) {
                const ref = db.collection('shops').doc(SHOP_ID).collection('menu').doc('items');
                db.runTransaction(async t => {
                    const doc = await t.get(ref);
                    const list = doc.exists ? doc.data().customItems : [];
                    list.push({name: form[0], price: parseInt(form[1]), available: true});
                    t.set(ref, {customItems: list}, {merge: true});
                });
            }
        };

        window.delItem = (idx) => {
            const ref = db.collection('shops').doc(SHOP_ID).collection('menu').doc('items');
            db.runTransaction(async t => {
                const doc = await t.get(ref);
                const list = doc.data().customItems;
                list.splice(idx, 1);
                t.update(ref, {customItems: list});
            });
        };

        function switchForm(f) {
            document.getElementById('form-login').style.display = f==='login'?'block':'none';
            document.getElementById('form-register').style.display = f==='register'?'block':'none';
        }

        function showScreen(name) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-'+name).classList.add('active');
        }

        window.logout = () => { localStorage.removeItem('nb_shop_id'); location.reload(); };

        // Start
        init();
        
        // Stop sound on click
        document.body.onclick = () => { if(isRinging) { audio.pause(); audio.currentTime=0; isRinging=false; } };

    </script>
</body>
</html>
