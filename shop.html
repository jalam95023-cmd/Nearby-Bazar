<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merchant Partner - Nearby Bazar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; padding-bottom: 80px; }
        .header { background: #2ecc71; color: white; padding: 20px; border-radius: 0 0 20px 20px; text-align: center; }
        .order-card { border-left: 5px solid #2ecc71; margin-bottom: 15px; }
        .nav-bottom { position: fixed; bottom: 0; width: 100%; background: white; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-around; padding: 10px; z-index: 1000; }
        .nav-btn { border: none; background: none; font-size: 24px; color: #aaa; }
        .nav-btn.active { color: #2ecc71; }
        #login-screen, #dashboard-screen, #inventory-screen { display: none; }
    </style>
</head>
<body>

    <div id="login-screen" class="container mt-5">
        <div class="text-center mb-4">
            <h2>ğŸª Partner App</h2>
            <p>Grow your business online</p>
        </div>
        <div class="card p-4 shadow-sm">
            <input type="text" id="shopName" class="form-control mb-3" placeholder="Shop Name (e.g. Sharma Kirana)">
            <input type="text" id="ownerName" class="form-control mb-3" placeholder="Owner Name">
            <input type="tel" id="phone" class="form-control mb-3" placeholder="Mobile Number">
            <button onclick="registerShop()" class="btn btn-success w-100 btn-lg">ğŸš€ Register Shop</button>
            <p id="reg-status" class="mt-3 text-center text-muted small"></p>
        </div>
    </div>

    <div id="dashboard-screen">
        <div class="header">
            <h3 id="shop-title">My Shop</h3>
            <span class="badge bg-light text-dark" id="shop-status">Status: Checking...</span>
        </div>
        
        <div class="container mt-4">
            <h5>ğŸ”” Live Orders</h5>
            <div id="orders-list">
                <div class="text-center text-muted mt-5">
                    <p>No new orders yet.</p>
                    <small>Share your shop link to get customers!</small>
                </div>
            </div>
        </div>
    </div>

    <div id="inventory-screen">
        <div class="header" style="background: #3498db;">
            <h3>ğŸ“¦ My Inventory</h3>
        </div>
        <div class="container mt-4">
            <div class="input-group mb-3">
                <input type="text" id="item-name" class="form-control" placeholder="Item Name (e.g. Milk)">
                <input type="number" id="item-price" class="form-control" placeholder="Price (â‚¹)">
                <button class="btn btn-primary" onclick="addItem()">Add</button>
            </div>
            <ul class="list-group" id="inventory-list">
                </ul>
        </div>
    </div>

    <div class="nav-bottom" id="bottom-nav" style="display:none;">
        <button class="nav-btn active" onclick="switchTab('dashboard')">ğŸ </button>
        <button class="nav-btn" onclick="switchTab('inventory')">ğŸ“¦</button>
        <button class="nav-btn" onclick="alert('Profile Settings coming soon!')">âš™ï¸</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, updateDoc, doc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDm_yS9tmdfnMmhoUiGwLSAnQpz5trXuko",
            authDomain: "nearby-bazar.firebaseapp.com",
            projectId: "nearby-bazar",
            storageBucket: "nearby-bazar.firebasestorage.app",
            messagingSenderId: "183262510084",
            appId: "1:183262510084:web:909fa3aac2f2429a7d8951"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Simple LocalStorage Login System (For Prototype)
        let myShopId = localStorage.getItem("shopId");

        // --- 1. Screen Management ---
        function checkLogin() {
            if (myShopId) {
                document.getElementById("login-screen").style.display = "none";
                document.getElementById("dashboard-screen").style.display = "block";
                document.getElementById("bottom-nav").style.display = "flex";
                loadShopData();
                loadInventory();
            } else {
                document.getElementById("login-screen").style.display = "block";
            }
        }
        checkLogin();

        window.switchTab = (tab) => {
            document.getElementById("dashboard-screen").style.display = "none";
            document.getElementById("inventory-screen").style.display = "none";
            
            if(tab === 'dashboard') document.getElementById("dashboard-screen").style.display = "block";
            if(tab === 'inventory') document.getElementById("inventory-screen").style.display = "block";
        }

        // --- 2. Registration Logic ---
        window.registerShop = async () => {
            const name = document.getElementById("shopName").value;
            const owner = document.getElementById("ownerName").value;
            const phone = document.getElementById("phone").value;
            
            if (!name || !owner || !phone) return alert("Please fill all details");

            document.getElementById("reg-status").innerText = "Registering...";
            
            try {
                // Get Location
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    const docRef = await addDoc(collection(db, "shops"), {
                        shopName: name,
                        ownerName: owner,
                        phone: phone,
                        lat: pos.coords.latitude,
                        lng: pos.coords.longitude,
                        status: "pending", // Admin approval chahiye
                        wallet: 0,
                        createdAt: new Date()
                    });
                    
                    localStorage.setItem("shopId", docRef.id);
                    myShopId = docRef.id;
                    alert("Registration Successful! Waiting for Admin Approval.");
                    checkLogin();
                }, () => {
                    alert("Location Permission Denied! Location is required.");
                    document.getElementById("reg-status").innerText = "Error: Allow Location";
                });
            } catch (e) {
                alert("Error: " + e.message);
            }
        };

        // --- 3. Shop Data & Status ---
        function loadShopData() {
            onSnapshot(doc(db, "shops", myShopId), (doc) => {
                const data = doc.data();
                document.getElementById("shop-title").innerText = data.shopName;
                document.getElementById("shop-status").innerText = "Status: " + data.status.toUpperCase();
                
                if(data.status === 'verified') {
                    document.getElementById("shop-status").className = "badge bg-success";
                } else if (data.status === 'rejected' || data.status === 'suspended') {
                    document.getElementById("shop-status").className = "badge bg-danger";
                    alert("Your shop is " + data.status);
                }
            });
        }

        // --- 4. Inventory Management ---
        window.addItem = async () => {
            const item = document.getElementById("item-name").value;
            const price = document.getElementById("item-price").value;
            
            if(!item || !price) return;
            
            await addDoc(collection(db, `shops/${myShopId}/inventory`), {
                name: item,
                price: price,
                inStock: true
            });
            
            document.getElementById("item-name").value = "";
            document.getElementById("item-price").value = "";
        };

        function loadInventory() {
            onSnapshot(collection(db, `shops/${myShopId}/inventory`), (snapshot) => {
                let html = "";
                snapshot.forEach(doc => {
                    const i = doc.data();
                    html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                        ${i.name} - â‚¹${i.price}
                        <span class="badge bg-primary rounded-pill">In Stock</span>
                    </li>`;
                });
                document.getElementById("inventory-list").innerHTML = html;
            });
        }
    </script>
</body>
</html>
