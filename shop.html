<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partner App - Nearby Bazar</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* SGMC Dark Theme */
        :root { --bg: #050505; --card: #141414; --border: #333; --accent: #F97316; --text: #fff; }
        body { background-color: var(--bg); color: var(--text); font-family: sans-serif; padding-bottom: 80px; }
        
        .aesthetic-card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 16px; margin-bottom: 12px; }
        .full-screen { position: fixed; inset: 0; background: #000; z-index: 50; display: flex; flex-direction: column; justify-content: center; padding: 24px; overflow-y: auto; }
        
        input { background: #222; border: 1px solid #444; color: white; padding: 14px; width: 100%; border-radius: 12px; margin-bottom: 12px; outline: none; }
        .btn-primary { background: linear-gradient(to right, #ea580c, #c2410c); color: white; padding: 14px; border-radius: 12px; font-weight: bold; width: 100%; }
        
        /* Status Pills */
        .status-pill { padding: 4px 10px; border-radius: 6px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
        .status-pending { background: rgba(234, 179, 8, 0.2); color: #fbbf24; border: 1px solid rgba(234, 179, 8, 0.3); animation: pulse 2s infinite; }
        .status-cooking { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); }
        .status-ready { background: rgba(34, 197, 94, 0.2); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.3); }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(234, 179, 8, 0); } 100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); } }

        /* Sidebar */
        .sidebar { position: fixed; top: 0; right: 0; bottom: 0; width: 280px; background: var(--bg); z-index: 100; transform: translateX(100%); transition: 0.3s; border-left: 1px solid var(--border); }
        .sidebar.open { transform: translateX(0); }
        .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); opacity: 0; pointer-events: none; transition: 0.3s; z-index: 90; backdrop-filter: blur(4px); }
        .sidebar-overlay.open { opacity: 1; pointer-events: auto; }

        /* Tabs */
        .tab-btn { color: #9ca3af; border-bottom: 2px solid transparent; padding-bottom: 12px; flex: 1; text-align: center; }
        .tab-active { color: var(--accent); border-bottom: 2px solid var(--accent); font-weight: bold; }
    </style>
</head>
<body>

    <div id="auth-screen" class="full-screen">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-orange-500 mb-2">Nearby Bazar</h1>
            <p class="text-gray-500 text-sm">Partner Login</p>
        </div>

        <div id="login-form">
            <input type="text" id="login-id" placeholder="Shop ID (e.g. gupta01)">
            <input type="password" id="login-pass" placeholder="Password">
            <button id="btn-login" class="btn-primary mb-4">Login</button>
            <p class="text-center text-gray-500 text-xs mt-4">New Shop? <span id="link-register" class="text-orange-400 cursor-pointer font-bold">Register Here</span></p>
        </div>

        <div id="register-form" class="hidden">
            <h2 class="text-xl font-bold mb-4 text-white">Register Shop</h2>
            <input type="text" id="reg-name" placeholder="Shop Name">
            <input type="text" id="reg-owner" placeholder="Owner Name">
            <input type="tel" id="reg-phone" placeholder="Mobile Number">
            <input type="text" id="reg-id" placeholder="Create Username (Unique)">
            <input type="password" id="reg-pass" placeholder="Create Password">
            <input type="text" id="reg-upi" placeholder="UPI ID">
            <button id="btn-reg" class="btn-primary mb-4">Submit Application</button>
            <p class="text-center text-gray-500 text-xs mt-4">Have ID? <span id="link-login" class="text-orange-400 cursor-pointer font-bold">Login Here</span></p>
        </div>
    </div>

    <div id="status-screen" class="full-screen hidden text-center">
        <h2 class="text-2xl font-bold text-white mb-2">Approval Pending</h2>
        <p class="text-gray-400 text-sm mb-6">Your shop <span id="status-name" class="text-orange-500"></span> is under review.</p>
        <div class="bg-gray-900 p-4 rounded-xl border border-gray-800 mx-4 text-left">
            <p class="text-xs text-gray-500 uppercase mb-2">Status</p>
            <div class="flex items-center gap-2"><div class="w-3 h-3 bg-yellow-500 rounded-full animate-pulse"></div><span class="text-yellow-500 text-sm font-bold">Verification In Progress...</span></div>
        </div>
        <button id="btn-logout-pending" class="mt-8 text-gray-500 text-xs underline">Logout</button>
    </div>

    <div id="main-app" class="hidden p-4">
        
        <div class="flex justify-between items-center mb-6">
            <div><h1 class="text-2xl font-bold text-orange-500" id="dash-name">My Shop</h1><p class="text-[10px] text-green-500 font-bold uppercase">● Online Pro</p></div>
            <button id="btn-menu" class="w-10 h-10 rounded-full bg-gray-800 border border-gray-700 text-white flex items-center justify-center"><i class="fas fa-bars"></i></button>
        </div>

        <div id="sidebar-overlay" class="sidebar-overlay"></div>
        <div id="sidebar" class="sidebar p-6 flex flex-col h-full">
            <div class="flex justify-between items-center mb-8"><h2 class="text-xl font-bold text-orange-500">Menu</h2><button id="btn-close-menu" class="text-gray-500 text-xl"><i class="fas fa-times"></i></button></div>
            <div class="space-y-3 flex-1">
                <div class="aesthetic-card p-3 flex justify-between items-center bg-opacity-50"><span>Shop Status</span><button id="shop-toggle-btn" class="px-3 py-1 rounded text-xs font-bold bg-green-600 text-white shadow">OPEN</button></div>
                <button id="btn-sound" class="w-full text-left p-3 rounded-xl border border-gray-800 text-sm font-bold text-white"><i class="fas fa-volume-up text-blue-400 mr-2"></i> Sound: <span id="txt-sound">ON</span></button>
                <button id="btn-inventory" class="w-full text-left p-3 rounded-xl border border-gray-800 text-sm font-bold text-white"><i class="fas fa-boxes text-orange-400 mr-2"></i> Inventory</button>
                <button id="btn-logout" class="w-full text-left p-3 rounded-xl border border-red-900/50 bg-red-900/10 text-red-400 text-sm font-bold mt-auto"><i class="fas fa-sign-out-alt mr-2"></i> Logout</button>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="aesthetic-card text-center !mb-0"><span class="text-xs uppercase text-gray-500">Revenue</span><h2 class="text-2xl font-bold text-green-500 mt-1">₹<span id="stat-sales">0</span></h2></div>
            <div class="aesthetic-card text-center !mb-0"><span class="text-xs uppercase text-gray-500">Active</span><h2 class="text-3xl font-bold text-yellow-500 mt-1" id="stat-active">0</h2></div>
        </div>

        <div class="flex mb-4 border-b border-gray-800">
            <button id="tab-live" class="tab-btn tab-active text-sm">LIVE</button>
            <button id="tab-history" class="tab-btn text-sm">HISTORY</button>
        </div>

        <div id="view-live" class="space-y-3 pb-20"></div>
        <div id="view-history" class="hidden space-y-3"><p class="text-center text-gray-600 text-sm">No history yet.</p></div>
    </div>

    <div id="modal-inventory" class="fixed inset-0 bg-black z-50 hidden flex flex-col p-4">
        <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-white">Inventory</h2><button id="close-inv" class="text-gray-400 text-xl"><i class="fas fa-times"></i></button></div>
        <div id="inventory-list" class="flex-1 overflow-y-auto space-y-3"></div>
        <button id="btn-add-item" class="w-full bg-orange-600 text-white py-4 rounded-xl font-bold mt-4 shadow-lg sticky bottom-0">Add New Product</button>
    </div>

    <audio id="order-sound"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, onSnapshot, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // --- CONFIGURATION (Nearby Bazar) ---
        const firebaseConfig = { 
            apiKey: "AIzaSyDm_yS9tmdfnMmhoUiGwLSAnQpz5trXuko", 
            authDomain: "nearby-bazar.firebaseapp.com", 
            projectId: "nearby-bazar", 
            storageBucket: "nearby-bazar.firebasestorage.app", 
            messagingSenderId: "183262510084", 
            appId: "1:183262510084:web:909fa3aac2f2429a7d8951" 
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let SHOP_ID = localStorage.getItem('nb_shop_id');
        let soundEnabled = true;
        let isRinging = false;
        const audioEl = document.getElementById('order-sound');

        // --- EVENT LISTENERS ---
        document.getElementById('btn-login').addEventListener('click', login);
        document.getElementById('btn-reg').addEventListener('click', registerShop);
        document.getElementById('link-register').addEventListener('click', () => toggleAuth('register'));
        document.getElementById('link-login').addEventListener('click', () => toggleAuth('login'));
        
        document.getElementById('btn-menu').addEventListener('click', toggleSidebar);
        document.getElementById('sidebar-overlay').addEventListener('click', toggleSidebar);
        document.getElementById('btn-close-menu').addEventListener('click', toggleSidebar);
        document.getElementById('btn-logout').addEventListener('click', logout);
        document.getElementById('btn-logout-pending').addEventListener('click', logout);
        
        document.getElementById('shop-toggle-btn').addEventListener('click', toggleShopStatus);
        document.getElementById('btn-sound').addEventListener('click', toggleSound);
        
        document.getElementById('btn-inventory').addEventListener('click', openInventory);
        document.getElementById('close-inv').addEventListener('click', () => document.getElementById('modal-inventory').classList.add('hidden'));
        document.getElementById('btn-add-item').addEventListener('click', addNewItem);

        document.getElementById('tab-live').addEventListener('click', () => switchTab('live'));
        document.getElementById('tab-history').addEventListener('click', () => switchTab('history'));

        // --- AUTH ---
        function checkAuth() {
            if(SHOP_ID) {
                document.getElementById('auth-screen').classList.add('hidden');
                initShopListener();
            }
        }

        function toggleAuth(mode) {
            document.getElementById('login-form').classList.toggle('hidden', mode === 'register');
            document.getElementById('register-form').classList.toggle('hidden', mode === 'login');
        }

        async function login() {
            const id = document.getElementById('login-id').value.trim().toLowerCase();
            const pass = document.getElementById('login-pass').value.trim();
            
            if(!id || !pass) return Swal.fire("Error", "Enter Details", "error");
            
            try {
                const docSnap = await getDoc(doc(db, "shops", id));
                if(docSnap.exists() && docSnap.data().password === pass) {
                    localStorage.setItem('nb_shop_id', id);
                    SHOP_ID = id;
                    checkAuth();
                } else {
                    Swal.fire("Error", "Invalid Credentials", "error");
                }
            } catch(e) { Swal.fire("Error", e.message, "error"); }
        }

        async function registerShop() {
            const id = document.getElementById('reg-id').value.trim().toLowerCase().replace(/\s/g,'');
            const name = document.getElementById('reg-name').value;
            const btn = document.getElementById('btn-reg');

            if(!id || !name) return Swal.fire("Error", "Fill details", "warning");
            
            btn.innerText = "Processing..."; btn.disabled = true;

            try {
                const docRef = doc(db, "shops", id);
                const docSnap = await getDoc(docRef);
                if(docSnap.exists()) throw new Error("Shop ID taken");

                // Location Fallback
                let lat=0, lng=0;
                try {
                    const pos = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej, {timeout:2000}));
                    lat = pos.coords.latitude; lng = pos.coords.longitude;
                } catch(e) {}

                await setDoc(docRef, {
                    shopId: id, shopName: name,
                    ownerName: document.getElementById('reg-owner').value,
                    phone: document.getElementById('reg-phone').value,
                    password: document.getElementById('reg-pass').value,
                    upiId: document.getElementById('reg-upi').value,
                    status: 'pending', isOpen: false, location: {lat, lng},
                    createdAt: serverTimestamp()
                });

                // Init Menu
                await setDoc(doc(db, `shops/${id}/menu`, "items"), { customItems: [] });

                Swal.fire("Success", "Request Sent!", "success");
                toggleAuth('login');
            } catch(e) {
                Swal.fire("Error", e.message, "error");
            } finally {
                btn.innerText = "Submit Application"; btn.disabled = false;
            }
        }

        function logout() { localStorage.removeItem('nb_shop_id'); location.reload(); }

        // --- SHOP LOGIC ---
        function initShopListener() {
            onSnapshot(doc(db, "shops", SHOP_ID), (d) => {
                if(!d.exists()) { logout(); return; }
                const s = d.data();

                if(s.status === 'pending') {
                    document.getElementById('status-screen').classList.remove('hidden');
                    document.getElementById('main-app').classList.add('hidden');
                    document.getElementById('status-name').innerText = s.shopName;
                } else if(s.status === 'suspended') {
                    Swal.fire("Suspended", "Contact Admin", "error").then(logout);
                } else {
                    // Approved
                    document.getElementById('status-screen').classList.add('hidden');
                    document.getElementById('main-app').classList.remove('hidden');
                    document.getElementById('dash-name').innerText = s.shopName;
                    updateShopUI(s.isOpen);
                    loadOrders();
                }
            });
        }

        function updateShopUI(isOpen) {
            const btn = document.getElementById('shop-toggle-btn');
            btn.innerText = isOpen ? "OPEN" : "CLOSED";
            btn.className = isOpen ? "px-3 py-1 rounded text-xs font-bold bg-green-600 text-white shadow" : "px-3 py-1 rounded text-xs font-bold bg-red-600 text-white shadow";
        }

        async function toggleShopStatus() {
            const btn = document.getElementById('shop-toggle-btn');
            await updateDoc(doc(db, "shops", SHOP_ID), { isOpen: btn.innerText === "CLOSED" });
        }

        function loadOrders() {
            const q = query(collection(db, "orders"), where("shopId", "==", SHOP_ID), orderBy("timestamp", "desc"));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('view-live');
                let html = "";
                let active = 0, sales = 0;
                let shouldRing = false;

                snap.forEach(docSnap => {
                    const d = docSnap.data();
                    const id = docSnap.id;
                    
                    if(d.status === 'completed') sales += (parseInt(d.totalAmount)||0);
                    
                    if(['pending','cooking','ready'].includes(d.status)) {
                        active++;
                        if(d.status === 'pending') shouldRing = true;
                        
                        const itemsStr = d.items.map(i => `${i.qty} x ${i.name}`).join(', ');
                        
                        html += `
                        <div class="live-card">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-bold text-lg text-white">${d.customerName}</h3>
                                <span class="status-pill ${d.status==='pending'?'status-pending':d.status==='cooking'?'status-cooking':'status-ready'}">${d.status}</span>
                            </div>
                            <p class="text-xs text-gray-400 mb-2 truncate">${itemsStr}</p>
                            <div class="flex justify-between items-center mt-2">
                                <span class="font-bold text-orange-500 text-xl">₹${d.totalAmount}</span>
                                <div class="flex gap-2">
                                    ${getActions(id, d.status)}
                                </div>
                            </div>
                        </div>`;
                    }
                });

                list.innerHTML = html || "<p class='text-center text-gray-600 mt-10 text-sm'>No active orders</p>";
                document.getElementById('pending-count').innerText = active;
                document.getElementById('stat-sales').innerText = sales;
                
                if(shouldRing && !isRinging) playAlarm();
                if(!shouldRing) stopAlarm();
            });
        }

        function getActions(id, status) {
            if(status === 'pending') return `<button onclick="window.upd('${id}','cooking')" class="bg-blue-600 px-3 py-1 rounded text-xs font-bold text-white">Accept</button><button onclick="window.upd('${id}','rejected')" class="bg-red-600 px-3 py-1 rounded text-xs font-bold text-white">Reject</button>`;
            if(status === 'cooking') return `<button onclick="window.upd('${id}','ready')" class="bg-yellow-600 text-black px-3 py-1 rounded text-xs font-bold">Ready</button>`;
            if(status === 'ready') return `<button onclick="window.upd('${id}','completed')" class="bg-green-600 px-3 py-1 rounded text-xs font-bold text-white">Done</button>`;
            return "";
        }

        window.upd = async (id, st) => { await updateDoc(doc(db, "orders", id), { status: st }); };

        // --- INVENTORY ---
        function openInventory() {
            document.getElementById('modal-inventory').classList.remove('hidden');
            onSnapshot(doc(db, `shops/${SHOP_ID}/menu`, "items"), (d) => {
                const items = d.exists() ? d.data().customItems || [] : [];
                document.getElementById('inventory-list').innerHTML = items.map((i, idx) => `
                    <div class="aesthetic-card flex justify-between items-center p-3 mb-2">
                        <div><p class="font-bold text-white">${i.name}</p><p class="text-xs text-gray-400">₹${i.price}</p></div>
                        <button onclick="window.delItem(${idx})" class="text-red-500"><i class="fas fa-trash"></i></button>
                    </div>
                `).join('');
            });
        }

        window.addNewItem = async () => {
            const { value: form } = await Swal.fire({
                title: 'New Item',
                html: '<input id="sw-name" placeholder="Name" class="swal2-input"><input id="sw-price" type="number" placeholder="Price" class="swal2-input">',
                preConfirm: () => [document.getElementById('sw-name').value, document.getElementById('sw-price').value]
            });
            if(form && form[0]) {
                const ref = doc(db, `shops/${SHOP_ID}/menu`, "items");
                const snap = await getDoc(ref);
                let items = snap.exists() ? snap.data().customItems : [];
                items.push({name: form[0], price: parseInt(form[1]), available: true});
                await setDoc(ref, {customItems: items}, {merge: true});
                Swal.fire("Added", "", "success");
            }
        };

        window.delItem = async (idx) => {
            const ref = doc(db, `shops/${SHOP_ID}/menu`, "items");
            const snap = await getDoc(ref);
            let items = snap.data().customItems;
            items.splice(idx, 1);
            await updateDoc(ref, {customItems: items});
        };

        // --- UTILS ---
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('sidebar-overlay').classList.toggle('open'); }
        function switchTab(t) { 
            document.getElementById('view-live').classList.add('hidden'); document.getElementById('view-history').classList.add('hidden');
            document.getElementById('tab-live').classList.remove('tab-active'); document.getElementById('tab-history').classList.remove('tab-active');
            document.getElementById('view-'+t).classList.remove('hidden'); document.getElementById('tab-'+t).classList.add('tab-active');
        }
        
        function playAlarm() { if(soundEnabled && !isRinging) { audioEl.src = "https://assets.mixkit.co/active_storage/sfx/2865/2865-preview.mp3"; audioEl.loop = true; audioEl.play().catch(e=>{}); isRinging=true; updateSoundUI(); } }
        function stopAlarm() { if(isRinging) { audioEl.pause(); audioEl.currentTime=0; isRinging=false; updateSoundUI(); } }
        function toggleSound() { soundEnabled = !soundEnabled; if(!soundEnabled) stopAlarm(); updateSoundUI(); }
        function updateSoundUI() { const txt = soundEnabled ? "ON" : "OFF"; document.getElementById('sound-status').innerText = isRinging ? "RINGING!" : "Sound: " + txt; document.getElementById('txt-sound').innerText = txt; }
        window.stopAlarmInteraction = () => { if(isRinging) stopAlarm(); };

        checkAuth();
    </script>
</body>
</html>
