<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendor Partner - Nearby Bazar</title>
    <meta name="theme-color" content="#0f0f0f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* --- PRO AESTHETICS --- */
        :root { --bg: #050505; --card: #141414; --border: #333; --accent: #F97316; --text: #fff; --text-sub: #9ca3af; --modal-bg: #050505; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; padding-bottom: 80px; -webkit-tap-highlight-color: transparent; }
        
        /* Auth Screen */
        #auth-screen { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; flex-direction: column; justify-content: center; padding: 24px; overflow-y: auto; }
        .auth-input { background: #1a1a1a; border: 1px solid #333; color: white; padding: 15px; width: 100%; border-radius: 12px; margin-bottom: 15px; outline: none; font-size: 16px; }
        .auth-input:focus { border-color: var(--accent); }
        
        .aesthetic-card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 12px; position: relative; }
        .live-card { background: rgba(20, 20, 20, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px; padding: 18px; margin-bottom: 12px; transition: all 0.3s ease; position: relative; overflow: hidden; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); }
        
        .status-pill { padding: 4px 10px; border-radius: 6px; font-size: 10px; font-weight: 800; text-transform: uppercase; }
        .status-pending { background: rgba(234, 179, 8, 0.2); color: #fbbf24; border: 1px solid rgba(234, 179, 8, 0.3); animation: pulse 2s infinite; }
        .status-cooking { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); }
        .status-ready { background: rgba(34, 197, 94, 0.2); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.3); }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(234, 179, 8, 0); } 100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); } }

        .sidebar { position: fixed; top: 0; right: 0; bottom: 0; width: 280px; background: var(--bg); z-index: 100; transform: translateX(100%); transition: 0.3s; border-left: 1px solid var(--border); }
        .sidebar.open { transform: translateX(0); }
        .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); opacity: 0; pointer-events: none; transition: 0.3s; z-index: 90; backdrop-filter: blur(4px); }
        .sidebar-overlay.open { opacity: 1; pointer-events: auto; }

        .fs-modal { position: fixed; inset: 0; background: var(--modal-bg); z-index: 120; transform: translateY(100%); transition: transform 0.3s; overflow-y: auto; }
        .fs-modal.open { transform: translateY(0); }
        
        .popup-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 160; display: none; align-items: center; justify-content: center; }
        .popup-modal.open { display: flex; opacity: 1; pointer-events: auto; }

        input, textarea, select { background: var(--card); border: 1px solid var(--border); color: var(--text); padding: 12px; rounded: 12px; width: 100%; outline: none; margin-bottom: 8px; }
        
        .tab-btn { color: var(--text-sub); border-bottom: 2px solid transparent; transition: 0.3s; padding-bottom: 12px; flex: 1; text-align: center; cursor: pointer; }
        .tab-active { color: var(--accent); border-bottom: 2px solid var(--accent); font-weight: bold; }

        /* Custom Toast (The Aesthetic Pill) */
        #custom-toast { 
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(20px); 
            background: rgba(25, 25, 25, 0.95); backdrop-filter: blur(10px);
            padding: 10px 24px; border-radius: 50px; border: 1px solid #333;
            color: white; font-size: 13px; font-weight: 600; opacity: 0; pointer-events: none; 
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 9999;
            display: flex; align-items: center; gap: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        #custom-toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        #custom-toast i { color: var(--accent); }
    </style>
</head>
<body class="p-4 max-w-2xl mx-auto" onclick="enableAudio()">

    <div id="auth-screen" style="display:none;">
        <div class="text-center mb-10">
            <h1 class="text-4xl font-bold text-orange-500 mb-2">Nearby Bazar</h1>
            <p class="text-gray-500 text-sm tracking-widest uppercase">Partner Login</p>
        </div>
        <div id="login-form">
            <input type="text" id="login-id" class="auth-input" placeholder="Shop Username (e.g. sgmc)">
            <input type="password" id="login-pass" class="auth-input" placeholder="Password">
            <button onclick="handleLogin()" id="login-btn" class="w-full bg-gradient-to-r from-orange-600 to-red-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg mb-4 cursor-pointer relative z-50">Login</button>
            <p class="text-center text-gray-500 text-sm">New Shop? <span onclick="toggleAuth('register')" class="text-orange-400 font-bold cursor-pointer">Register Here</span></p>
        </div>
        <div id="register-form" class="hidden">
            <h2 class="text-xl font-bold text-white mb-4">Register Shop</h2>
            <input type="text" id="reg-name" class="auth-input" placeholder="Shop Name">
            <input type="text" id="reg-owner" class="auth-input" placeholder="Owner Name">
            <input type="tel" id="reg-phone" class="auth-input" placeholder="Phone">
            <input type="text" id="reg-id" class="auth-input" placeholder="Create Username">
            <input type="password" id="reg-pass" class="auth-input" placeholder="Create Password">
            <input type="text" id="reg-upi" class="auth-input" placeholder="UPI ID">
            <button onclick="handleRegister()" id="reg-btn" class="w-full bg-green-600 text-white py-4 rounded-xl font-bold shadow-lg mb-4">Submit</button>
            <p class="text-center text-gray-500 text-sm">Have ID? <span onclick="toggleAuth('login')" class="text-orange-400 font-bold cursor-pointer">Login Here</span></p>
        </div>
    </div>

    <div id="status-screen" class="hidden fixed inset-0 bg-black z-[100] flex flex-col justify-center items-center p-6 text-center">
        <h2 class="text-3xl font-bold text-white mb-2">Approval Pending</h2>
        <p class="text-gray-400 mb-6">Shop <span id="status-shop-name" class="text-orange-500 font-bold"></span> is under review.</p>
        <button onclick="logout()" class="mt-8 text-gray-500 text-xs underline">Logout / Refresh</button>
    </div>

    <div id="app-ui" class="hidden">
        <div class="flex justify-between items-center mb-6 relative z-50">
            <div>
                <h1 class="text-2xl font-bold text-orange-500" id="header-shop-name">My Shop</h1>
                <p class="text-[10px] text-green-500 font-bold uppercase tracking-wider">● Online Pro</p>
            </div>
            <div class="flex gap-3">
                <button onclick="setShopLocation()" class="w-10 h-10 rounded-full bg-blue-500/10 border border-blue-500/30 text-blue-500 flex items-center justify-center shadow-lg active:scale-95 z-50">
                    <i class="fas fa-map-marker-alt"></i>
                </button>
                <button onclick="toggleSidebar()" class="w-10 h-10 rounded-full bg-gray-800 border border-gray-700 text-white flex items-center justify-center shadow-lg active:scale-95 z-50 relative">
                    <i class="fas fa-bars"></i>
                    <span id="header-msg-dot" class="absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full hidden border-2 border-gray-800"></span>
                </button>
            </div>
        </div>

        <div id="sidebar-overlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>
        <div id="sidebar" class="sidebar p-6 flex flex-col h-full">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-xl font-bold text-orange-500">Menu</h2>
                <button onclick="toggleSidebar()" class="text-gray-500 text-xl"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="space-y-3 flex-1">
                <div class="aesthetic-card p-3 flex justify-between items-center bg-opacity-50">
                    <span class="font-bold text-sm">Shop Status</span>
                    <button id="shop-toggle-btn" onclick="toggleShopStatus()" class="px-3 py-1 rounded text-xs font-bold bg-green-600 text-white shadow">OPEN</button>
                </div>

                <button onclick="toggleSound()" class="w-full text-left p-3 rounded-xl flex items-center justify-between border border-gray-800 transition font-bold text-sm" style="border-color:var(--border)">
                    <span><i id="sidebar-sound-icon" class="fas fa-volume-up text-blue-400 mr-2"></i> Sound Alert</span>
                    <span id="sidebar-sound-status" class="text-xs bg-green-600 px-2 rounded text-white">ON</span>
                </button>

                <button onclick="openDeliverySettings(); toggleSidebar()" class="w-full text-left p-3 rounded-xl border border-gray-800 hover:bg-gray-800/50 transition font-bold text-sm" style="border-color:var(--border)">
                    <i class="fas fa-truck text-cyan-400 mr-2"></i> Delivery Settings
                </button>
                
                <button onclick="openRewardsModal(); toggleSidebar()" class="w-full text-left p-3 rounded-xl border border-gray-800 hover:bg-gray-800/50 transition font-bold text-sm" style="border-color:var(--border)">
                    <i class="fas fa-ticket-alt text-green-400 mr-2"></i> Offers & Coupons
                </button>

                <button onclick="openMenuControl(); toggleSidebar()" class="w-full text-left p-3 rounded-xl border border-gray-800 hover:bg-gray-800/50 transition font-bold text-sm" style="border-color:var(--border)">
                    <i class="fas fa-boxes text-orange-400 mr-2"></i> Inventory Control
                </button>

                <button onclick="switchView('messages'); toggleSidebar()" class="w-full text-left p-3 rounded-xl flex items-center justify-between border border-gray-800 hover:bg-gray-800/50 transition bg-opacity-50" style="border-color:var(--border)">
                    <span class="font-bold text-sm text-blue-400"><i class="fas fa-comments mr-2"></i> Messages</span>
                    <span id="sidebar-msg-count" class="text-xs bg-red-500 text-white px-2 py-0.5 rounded-full hidden">New</span>
                </button>

                <button onclick="logout()" class="w-full text-left p-3 rounded-xl border border-red-900/50 bg-red-900/10 text-red-400 font-bold text-sm mt-auto">
                    <i class="fas fa-sign-out-alt mr-2"></i> Logout
                </button>
            </div>
        </div>

        <div id="dashboard-section" class="grid grid-cols-2 gap-4 mb-6">
            <div class="aesthetic-card flex flex-col justify-between cursor-pointer relative overflow-hidden" onclick="openSalesAnalysis()">
                <div class="flex justify-between items-start z-10 relative">
                    <span class="text-xs uppercase tracking-wider opacity-70">Revenue</span>
                    <i class="fas fa-chart-pie text-green-500"></i>
                </div>
                <h2 class="text-2xl font-bold text-green-500 mt-2 z-10 relative">₹<span id="total-sales">0</span></h2>
            </div>
            <div class="aesthetic-card text-center flex flex-col justify-center">
                <span class="text-xs uppercase tracking-wider opacity-70">Active</span>
                <h2 class="text-3xl font-bold text-yellow-500 my-1" id="pending-count">0</h2>
                <p class="text-[10px] opacity-50 cursor-pointer" id="sound-status" onclick="toggleSound()">Sound: ON</p>
            </div>
        </div>

        <div id="tabs-section" class="flex mb-4 border-b border-gray-800" style="border-color:var(--border)">
            <button onclick="switchView('live')" id="tab-live" class="flex-1 py-3 tab-btn tab-active text-sm">LIVE</button>
            <button onclick="switchView('history')" id="tab-history" class="flex-1 py-3 tab-btn text-sm">HISTORY</button>
            <button onclick="switchView('udhaar')" id="tab-udhaar" class="flex-1 py-3 tab-btn text-sm">UDHAAR</button>
        </div>

        <div id="main-content">
            <div id="view-live" class="space-y-3 min-h-[50vh]"></div>

            <div id="view-history" class="hidden space-y-3">
                <input type="text" id="search-history" onkeyup="renderHistory()" placeholder="Search History..." class="mb-3">
                <div id="history-list" class="space-y-2"></div>
            </div>

            <div id="view-udhaar" class="hidden space-y-3">
                <input type="text" id="search-udhaar" onkeyup="renderUdhaar()" placeholder="Search Udhaar..." class="mb-3">
                <div id="udhaar-list" class="space-y-2"></div>
            </div>

            <div id="view-messages" class="hidden w-full h-[70vh] flex flex-col">
                <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-800">
                    <h2 class="text-xl font-bold text-white">Inbox</h2>
                    <button onclick="switchView('live')" class="text-gray-500"><i class="fas fa-times"></i></button>
                </div>
                <div id="messages-list" class="flex-1 overflow-y-auto space-y-2"></div>
            </div>
        </div>
    </div>

    <div id="custom-prompt" class="popup-modal" style="z-index: 250;"><div class="aesthetic-card w-full max-w-xs p-6"><h3 id="prompt-title" class="font-bold text-lg mb-4 text-center">Input</h3><input id="prompt-input" type="text" class="w-full bg-gray-900 border border-gray-800 rounded p-3 text-white mb-4 text-center"><div class="flex gap-2"><button onclick="document.getElementById('custom-prompt').classList.remove('open')" class="flex-1 py-2 rounded-xl bg-gray-800 text-gray-400 font-bold">Cancel</button><button id="prompt-confirm-btn" class="flex-1 py-2 rounded-xl bg-orange-600 text-white font-bold shadow-lg">Save</button></div></div></div>
    
    <div id="delivery-modal" class="popup-modal"><div class="aesthetic-card w-full max-w-xs p-6"><h3 class="font-bold text-lg mb-4">Delivery Settings</h3><label class="text-xs text-gray-500">Min Order</label><input type="number" id="del-min" class="mb-2"><label class="text-xs text-gray-500">Charge</label><input type="number" id="del-charge" class="mb-2"><label class="text-xs text-gray-500">Free Above</label><input type="number" id="del-free" class="mb-4"><div class="flex gap-2"><button onclick="document.getElementById('delivery-modal').classList.remove('open')" class="flex-1 bg-gray-800 py-2 rounded">Cancel</button><button onclick="saveDeliverySettings()" class="flex-1 bg-green-600 py-2 rounded font-bold">Save</button></div></div></div>

    <div id="rewards-modal" class="fs-modal p-4"><div class="flex justify-between items-center mb-6"><h3 class="font-bold text-xl">Coupons</h3><button onclick="document.getElementById('rewards-modal').classList.remove('open')"><i class="fas fa-times"></i></button></div><div class="aesthetic-card"><h4 class="font-bold text-green-500 mb-2">Create Coupon</h4><input id="coup-code" placeholder="Code" class="uppercase"><input id="coup-amt" type="number" placeholder="Discount ₹"><div class="flex items-center gap-2 mb-4"><input type="checkbox" id="coup-new" class="w-4 h-4"><span class="text-sm">New Customers Only</span></div><button onclick="createCoupon()" class="w-full bg-green-600 py-2 rounded text-sm font-bold mb-4">Create</button><div id="coupons-list" class="space-y-2"></div></div></div>

    <div id="menu-modal" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm z-[130]"><div class="aesthetic-card w-full max-w-sm h-[80vh] flex flex-col"><div class="flex justify-between mb-4"><h3 class="font-bold text-xl">Inventory</h3><button onclick="document.getElementById('menu-modal').classList.add('hidden')"><i class="fas fa-times"></i></button></div><div id="menu-list-items" class="overflow-y-auto flex-1 mb-4 space-y-2"></div><div class="sticky-add-btn"><button onclick="openAddItemModal()" class="w-full bg-gradient-to-r from-orange-600 to-yellow-500 text-white py-3.5 rounded-xl font-bold shadow-xl flex items-center justify-center gap-2"><i class="fas fa-plus"></i> Add New Item</button></div></div></div>
    
    <div id="add-item-modal" class="popup-modal"><div class="aesthetic-card w-full max-w-xs p-6 relative"><h3 class="font-bold text-lg mb-4 text-center">Add Product</h3><input id="new-item-name" placeholder="Item Name" class="mb-3"><div class="flex gap-2 mb-3"><input id="new-item-price" type="number" placeholder="Price" class="flex-1"><input id="new-item-stock" type="number" placeholder="Stock" class="w-20"></div><div class="flex gap-2 mb-3"><select id="new-item-cat" class="flex-1 p-3 rounded bg-gray-900 border border-gray-700 text-white text-sm"></select><button onclick="openPrompt('New Category', 'Name', (val)=>{ if(val){ currentMenuData.categories.push(val); saveMenuStatus(); openAddItemModal(); } })" class="w-12 bg-gray-800 border border-gray-700 rounded text-white font-bold hover:bg-gray-700">+</button></div><input id="new-item-img" placeholder="Image Link" class="mb-4 text-xs"><div class="flex gap-2"><button onclick="document.getElementById('add-item-modal').classList.remove('open')" class="flex-1 py-3 rounded-xl bg-gray-800 text-gray-400 font-bold">Cancel</button><button onclick="saveNewItem()" class="flex-1 py-3 rounded-xl bg-orange-600 text-white font-bold">Save</button></div></div></div>

    <div id="chat-screen" class="hidden fs-modal p-0" style="z-index: 200;">
        <div class="flex flex-col h-full bg-[#050505]">
            <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-[#141414]">
                <div class="flex items-center gap-3">
                    <button onclick="document.getElementById('chat-screen').classList.add('hidden')" class="text-gray-400"><i class="fas fa-arrow-left"></i></button>
                    <div><h3 class="font-bold text-white" id="chat-user-name">User</h3><p class="text-[10px] text-green-500">Online</p></div>
                </div>
                <a id="chat-call-btn" href="#" class="w-10 h-10 rounded-full bg-green-500/10 text-green-500 flex items-center justify-center"><i class="fas fa-phone"></i></a>
            </div>
            <div id="chat-bubbles" class="flex-1 overflow-y-auto p-4 space-y-2"></div>
            <div class="p-3 border-t border-gray-800 flex gap-2 bg-[#141414]">
                <input type="text" id="chat-input" placeholder="Type reply..." class="rounded-full px-4 text-sm bg-gray-900 border-none flex-1">
                <button onclick="sendMessage()" class="w-10 h-10 bg-orange-600 rounded-full text-white flex items-center justify-center"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <div id="order-full-modal" class="fs-modal p-4"><div class="max-w-2xl mx-auto min-h-screen flex flex-col"><div class="flex justify-between items-center mb-6"><button onclick="closeFullModal()" class="text-gray-400 flex items-center gap-2"><i class="fas fa-arrow-left"></i> Back</button><span id="fm-status-badge" class="text-xs font-bold uppercase px-3 py-1 rounded-full bg-gray-800 text-white">STATUS</span></div><div class="aesthetic-card mb-4"><h1 class="text-2xl font-bold" id="fm-name">Customer</h1><p class="text-sm opacity-70" id="fm-phone">Phone</p><div class="mt-2" id="fm-payment-info"></div><div id="fm-coupon-box" class="hidden mt-2 p-2 bg-green-900/20 border border-green-500/30 rounded flex justify-between"><span class="text-green-400 text-xs">Coupon: <span id="fm-coupon-code"></span></span><span class="text-green-400 font-bold text-sm">-₹<span id="fm-coupon-amt">0</span></span></div><div id="fm-recipient-box" class="hidden mt-3 p-2 bg-blue-500/10 border border-blue-500/30 rounded-lg"><p class="text-xs text-blue-400 font-bold"><i class="fas fa-gift mr-1"></i> Delivery For</p><p class="text-sm" id="fm-recipient">Name</p></div><p class="text-xs opacity-50 mt-2" id="fm-time"></p><p class="text-xs text-yellow-500 italic mt-1 hidden" id="fm-note"></p><p class="text-sm mt-3 border-t border-gray-700 pt-2 flex items-center gap-2" id="fm-address"><i class="fas fa-map-marker-alt text-red-500"></i> Address</p></div><div class="grid grid-cols-3 gap-3 mb-6"><a id="fm-btn-call" href="#" class="aesthetic-card flex flex-col items-center justify-center p-3"><i class="fas fa-phone text-green-500"></i> Call</a><a id="fm-btn-wa" href="#" target="_blank" class="aesthetic-card flex flex-col items-center justify-center p-3"><i class="fab fa-whatsapp text-green-500"></i> Chat</a><a id="fm-btn-map" href="#" target="_blank" class="aesthetic-card flex flex-col items-center justify-center p-3"><i class="fas fa-map-marker-alt text-blue-500"></i> Map</a></div><div class="aesthetic-card mb-6"><p class="text-xs uppercase font-bold opacity-50 mb-3">Items</p><div id="fm-items-list" class="space-y-3 pb-4 border-b border-gray-700 mb-4"></div><div class="flex justify-between"><span class="font-bold text-lg">Total</span><span class="font-bold text-2xl text-orange-500">₹<span id="fm-total">0</span></span></div></div><div id="fm-controls" class="space-y-3 pb-10"></div></div></div>

    <div id="sales-modal" class="hidden fixed inset-0 bg-black/95 z-[130] flex items-center justify-center p-4 backdrop-blur-sm"><div class="aesthetic-card w-full max-w-sm h-[85vh] flex flex-col"><div class="flex justify-between mb-6"><h3 class="font-bold text-xl">Analytics</h3><button onclick="document.getElementById('sales-modal').classList.add('hidden')"><i class="fas fa-times"></i></button></div><div class="grid grid-cols-2 gap-3 mb-6"><div class="p-4 rounded-xl bg-green-500/10 border border-green-500/20"><p class="text-xs text-green-400">Total Sales</p><p class="text-xl font-bold mt-1">₹<span id="an-sales">0</span></p></div><div class="p-4 rounded-xl bg-blue-500/10 border border-blue-500/20"><p class="text-xs text-blue-400">Orders</p><p class="text-xl font-bold mt-1" id="an-count">0</p></div></div><div class="mb-4"><h4 class="font-bold text-sm mb-2 text-gray-400">History</h4><div id="sales-history-list" class="space-y-1 text-xs max-h-32 overflow-y-auto border border-gray-800 p-2 rounded"></div></div><p class="text-xs uppercase font-bold opacity-50 mb-3 mt-4">Top Selling</p><div id="today-breakdown-list" class="overflow-y-auto flex-1 space-y-2"></div></div></div>
    
    <div id="logs-modal" class="hidden fixed inset-0 bg-black/95 z-[130] flex items-center justify-center p-4"><div class="aesthetic-card w-full max-w-sm h-[80vh] flex flex-col"><div class="flex justify-between mb-4 pb-2 border-b border-gray-700"><h3 class="font-bold text-lg">Payment Logs</h3><button onclick="document.getElementById('logs-modal').classList.add('hidden')"><i class="fas fa-times"></i></button></div><div id="logs-list" class="overflow-y-auto flex-1 space-y-2"></div></div></div>
    <div id="settle-modal" class="hidden fixed inset-0 bg-black/90 z-[160] flex items-center justify-center p-4"><div class="aesthetic-card w-full max-w-sm"><h3 class="font-bold">Settle Payment</h3><p id="settle-name" class="text-gray-400 text-sm mb-4"></p><h1 class="text-4xl font-bold text-red-400 mb-4 text-center">₹<span id="settle-due">0</span></h1><input id="settle-amount" type="number" class="text-center text-xl font-bold mb-4" placeholder="Amount"><button onclick="submitPayment()" class="w-full bg-green-600 p-3 rounded font-bold text-white shadow-lg">Settle</button><button onclick="document.getElementById('settle-modal').classList.add('hidden')" class="w-full mt-3 text-gray-500">Cancel</button></div></div>
    <div id="limit-modal" class="hidden fixed inset-0 bg-black/90 z-[160] flex items-center justify-center p-4"><div class="aesthetic-card w-full max-w-sm"><h3 class="font-bold mb-4">Set Limit</h3><p id="limit-name" class="mb-2 text-gray-400"></p><input id="limit-input" type="number" placeholder="Amount"><button onclick="saveLimit()" class="w-full bg-purple-600 p-3 rounded font-bold text-white mt-4">Save</button><button onclick="document.getElementById('limit-modal').classList.add('hidden')" class="w-full mt-2 text-gray-500">Cancel</button></div></div>

    <div id="custom-toast"><i class="fas fa-check-circle"></i><span id="toast-msg">Notification</span></div>

    <audio id="order-sound"></audio>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBadYpoNTL0dHkBQO4UddRVtPIfUOlf-bA", authDomain: "nearby-bazar.firebaseapp.com", projectId: "nearby-bazar", storageBucket: "nearby-bazar.firebasestorage.app", messagingSenderId: "183262510084", appId: "1:183262510084:web:85d9a50a3b51b30aae351f", measurementId: "G-4996NPF55N" };
        firebase.initializeApp(firebaseConfig); 
        const db = firebase.firestore();

        let SHOP_ID = localStorage.getItem('nb_shop_id');
        let soundEnabled = true;
        let isRinging = false;
        let allOrders = [];
        let currentMenuData = { customItems: [], categories: ['Chai', 'Snacks', 'Sutta'] };
        let currentOpenOrder = null;
        let todaysOrderCount = 0;
        let todaysItemsMap = {};
        let salesHistoryData = [];
        let udhaarMap = {};
        let limitsMap = {};
        let chatUsers = [];
        let currentChatUser = null;
        let currentLimitPhone = null;
        let currentSettlePhone = null;
        const audioEl = document.getElementById('order-sound');

        // --- AUTH ---
        // LOGIN PERSISTENCE FIX
        if(SHOP_ID) {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-ui').classList.remove('hidden');
            startListeners();
        } else {
            document.getElementById('auth-screen').style.display = 'flex';
        }

        function toggleAuth(m) { document.getElementById('login-form').classList.toggle('hidden', m!=='login'); document.getElementById('register-form').classList.toggle('hidden', m!=='register'); }
        
        function handleLogin() {
            const id = document.getElementById('login-id').value.trim().toLowerCase();
            const pass = document.getElementById('login-pass').value.trim();
            const btn = document.getElementById('login-btn');
            if(!id || !pass) return Swal.fire("Error","Enter credentials","error");
            btn.innerText = "Checking..."; btn.disabled = true;
            
            db.collection('shops').doc(id).get().then(doc => {
                btn.disabled = false; btn.innerText = "Login";
                if(doc.exists && doc.data().password === pass) {
                    if(doc.data().status === 'suspended') return Swal.fire("Blocked","Shop Suspended","error");
                    if(doc.data().status === 'pending') {
                        document.getElementById('auth-screen').style.display = 'none';
                        document.getElementById('status-screen').classList.remove('hidden');
                        document.getElementById('status-shop-name').innerText = doc.data().shopName;
                        db.collection('shops').doc(id).onSnapshot(d => {
                            if(d.exists && d.data().status === 'verified') {
                                localStorage.setItem('nb_shop_id', id); SHOP_ID = id;
                                document.getElementById('status-screen').classList.add('hidden');
                                document.getElementById('app-ui').classList.remove('hidden');
                                startListeners();
                            }
                        });
                        return;
                    }
                    localStorage.setItem('nb_shop_id', id); SHOP_ID = id; 
                    document.getElementById('auth-screen').style.display = 'none';
                    document.getElementById('app-ui').classList.remove('hidden');
                    startListeners();
                } else Swal.fire("Error","Invalid Login","error");
            }).catch(e => { btn.disabled = false; btn.innerText = "Login"; Swal.fire("Error",e.message,"error"); });
        }

        function handleRegister() {
            const id = document.getElementById('reg-id').value.trim().toLowerCase().replace(/\s/g,'');
            const data = {
                shopId: id, shopName: document.getElementById('reg-name').value,
                ownerName: document.getElementById('reg-owner').value, phone: document.getElementById('reg-phone').value,
                password: document.getElementById('reg-pass').value, upiId: document.getElementById('reg-upi').value,
                status: 'pending', isOpen: false, createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            let lat=0, lng=0;
            if(navigator.geolocation) navigator.geolocation.getCurrentPosition(p=>{lat=p.coords.latitude;lng=p.coords.longitude}, ()=>{}, {timeout:2000});
            data.location = {lat, lng};

            db.collection('shops').doc(id).set(data).then(() => {
                db.collection('shops').doc(id).collection('inventory').doc('placeholder').set({exists:true}); 
                Swal.fire("Success","Request Sent! Wait for approval","success"); toggleAuth('login');
            }).catch(e => Swal.fire("Error",e.message,"error"));
        }

        function logout() { localStorage.removeItem('nb_shop_id'); location.reload(); }

        // --- LISTENERS ---
        function startListeners() {
            db.collection('shops').doc(SHOP_ID).onSnapshot(d => { 
                if(d.exists) { 
                    const s = d.data(); 
                    document.getElementById('header-shop-name').innerText = s.shopName;
                    updateShopStatusUI(s.isOpen); 
                    if(s.status === 'suspended') { alert("Shop Suspended!"); logout(); }
                } 
            });

            db.collection('shops').doc(SHOP_ID).collection('inventory').onSnapshot(snap => { 
                currentMenuData.customItems = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
                if(!currentMenuData.categories) currentMenuData.categories = ['Chai', 'Snacks', 'Sutta'];
                if(!document.getElementById('menu-modal').classList.contains('hidden')) renderInventory();
            });

            db.collection('shops').doc(SHOP_ID).collection('user_limits').onSnapshot(s => { 
                limitsMap = {}; 
                s.docs.forEach(d => limitsMap[d.id] = d.data().limit); 
                if (!document.getElementById('view-udhaar').classList.contains('hidden')) renderUdhaar(); 
            });

            db.collection('shops').doc(SHOP_ID).collection('chats').onSnapshot(snap => {
                chatUsers = snap.docs.map(d => ({id: d.id, ...d.data()}));
                const hasMsg = chatUsers.length > 0;
                document.getElementById('sidebar-msg-count').classList.toggle('hidden', !hasMsg);
                if (!document.getElementById('view-messages').classList.contains('hidden')) renderMessagesList();
            });

            db.collection('orders').where('shopId', '==', SHOP_ID).orderBy('timestamp', 'desc').onSnapshot(snap => {
                allOrders = []; udhaarMap = {}; todaysItemsMap = {}; todaysOrderCount = 0; let sales = 0, active = 0, hasPending=false;
                snap.forEach(doc => {
                    const d = doc.data(); d.id = doc.id; allOrders.push(d);
                    if(d.paymentMode === 'Udhaar' && d.status !== 'cancelled') {
                        if (!udhaarMap[d.customerPhone]) udhaarMap[d.customerPhone] = {name: d.customerName, debit: 0, credit: 0};
                        udhaarMap[d.customerPhone].debit += d.totalAmount;
                    }
                    if(d.status === 'completed') { sales += d.totalAmount; todaysOrderCount++; d.items.forEach(i => { todaysItemsMap[i.name] = (todaysItemsMap[i.name]||0) + i.qty; }); }
                    if(['pending','cooking','ready'].includes(d.status)) active++;
                    if(d.status === 'pending' && (d.timestamp?.seconds > (Date.now()/1000 - 300))) hasPending = true;
                });
                document.getElementById('pending-count').innerText = active;
                document.getElementById('total-sales').innerText = sales;
                document.getElementById('total-sales').dataset.realValue = sales;
                if(hasPending) playAlarm();
                render(); 
            });
            
            db.collection('payments').where('shopId', '==', SHOP_ID).onSnapshot(s => {
                s.docs.forEach(d => { const p = d.data(); if(udhaarMap[p.phone]) udhaarMap[p.phone].credit += p.amount; });
                render();
            });
        }

        function render() {
            const list = document.getElementById('view-live');
            let html = '';
            allOrders.forEach(d => {
                if(['pending','cooking','ready'].includes(d.status)) {
                    const stClass = d.status === 'pending' ? 'status-pending' : d.status === 'cooking' ? 'status-cooking' : 'status-ready';
                    const payClass = d.paymentMode === 'Udhaar' ? 'pay-udhaar' : 'pay-cash';
                    html += `<div class="live-card cursor-pointer" onclick="openFullModal('${d.id}')">
                        <div class="flex justify-between items-start mb-3"><div><h3 class="font-bold text-lg text-white">${d.customerName}</h3></div><div><span class="status-pill ${stClass}">${d.status}</span><span class="pay-badge ${payClass}">${d.paymentMode}</span></div></div>
                        <div class="flex justify-between items-end"><span class="text-xs text-gray-400 font-bold">${d.items.length} Items</span><h3 class="font-bold text-2xl text-orange-400">₹${d.totalAmount}</h3></div>
                    </div>`;
                }
            });
            list.innerHTML = html || "<p class='text-center opacity-50 mt-10'>No active orders</p>";
            if(!document.getElementById('view-history').classList.contains('hidden')) renderHistory();
            if(!document.getElementById('view-udhaar').classList.contains('hidden')) renderUdhaar();
        }

        function openFullModal(id) {
            currentOpenOrder = allOrders.find(o => o.id === id); if(!currentOpenOrder) return;
            const d = currentOpenOrder;
            document.getElementById('fm-name').innerText = d.customerName; document.getElementById('fm-phone').innerText = d.customerPhone; document.getElementById('fm-status-badge').innerText = d.status;
            document.getElementById('fm-payment-info').innerHTML = `<span class="pay-badge ${d.paymentMode==='Udhaar'?'pay-udhaar':'pay-cash'}">${d.paymentMode}</span>`;
            if(d.coupon) { document.getElementById('fm-coupon-box').classList.remove('hidden'); document.getElementById('fm-coupon-box').classList.add('flex'); document.getElementById('fm-coupon-code').innerText = d.coupon.code; document.getElementById('fm-coupon-amt').innerText = d.coupon.discount; } else document.getElementById('fm-coupon-box').classList.add('hidden');
            if (d.recipient) { document.getElementById('fm-recipient-box').classList.remove('hidden'); document.getElementById('fm-recipient').innerText = `${d.recipient.name} (${d.recipient.phone})`; } else document.getElementById('fm-recipient-box').classList.add('hidden');
            document.getElementById('fm-items-list').innerHTML = d.items.map((i,idx) => `<div class="flex justify-between items-center p-2 rounded bg-gray-800/30 border border-gray-700"><div class="flex-1"><span class="text-sm font-bold">${i.name}</span></div><div class="flex items-center gap-3"><span class="text-sm font-bold text-orange-400 w-4 text-center">${i.qty}</span></div></div>`).join('');
            document.getElementById('fm-total').innerText = d.totalAmount;
            const callPh = d.recipient ? d.recipient.phone : d.customerPhone; 
            document.getElementById('fm-btn-call').href = `tel:${callPh}`; document.getElementById('fm-btn-wa').href = `https://wa.me/${callPh.replace(/\D/g, '')}`;
            document.getElementById('fm-btn-map').href = d.customerCoordinates ? `https://www.google.com/maps?q=${d.customerCoordinates.lat},${d.customerCoordinates.lng}` : "#";
            document.getElementById('fm-controls').innerHTML = `<div class="grid grid-cols-4 gap-2"><button onclick="updStatus('pending')" class="p-2 rounded bg-gray-700 text-white text-[10px] font-bold">Pending</button><button onclick="updStatus('cooking')" class="p-2 rounded bg-gray-700 text-white text-[10px] font-bold">Cooking</button><button onclick="updStatus('ready')" class="p-2 rounded bg-gray-700 text-white text-[10px] font-bold">Ready</button><button onclick="updStatus('completed')" class="p-2 rounded bg-green-600 text-white text-[10px] font-bold">Done</button></div><button onclick="deleteOrder()" class="w-full py-3 text-red-500 text-xs font-bold mt-4 border border-red-900/30 rounded-xl hover:bg-red-900/10"><i class="fas fa-trash mr-1"></i> DELETE ORDER</button>`;
            document.getElementById('order-full-modal').classList.add('open');
        }
        function updStatus(s) { db.collection('orders').doc(currentOpenOrder.id).update({status: s}).then(() => { document.getElementById('order-full-modal').classList.remove('open'); showPillToast("Status Updated"); }); }
        function closeFullModal() { document.getElementById('order-full-modal').classList.remove('open'); }
        function deleteOrder() { 
            Swal.fire({title:'Delete?', icon:'warning', showCancelButton:true}).then(r=>{ 
                if(r.isConfirmed) db.collection('orders').doc(currentOpenOrder.id).delete().then(() => { closeFullModal(); showPillToast("Deleted"); }); 
            });
        }

        // --- INVENTORY FIX ---
        function renderInventory() {
            document.getElementById('menu-list-items').innerHTML = currentMenuData.customItems.map((i) => `<div class="aesthetic-card flex justify-between items-center p-3 mb-2">
                <div class="flex items-center gap-3">
                    ${i.image?`<img src="${i.image}" class="item-thumb">`:''}
                    <div><span class="font-bold text-white block ${!i.available ? 'opacity-50 line-through' : ''}">${i.name}</span><span class="text-xs text-orange-400">₹${i.price} | Stock: ${i.stock||0} <button onclick="triggerAddStock('${i.id}')" class="ml-1 text-green-400 font-bold bg-green-900/50 px-2 rounded">+</button></span></div>
                </div>
                <div class="flex items-center gap-4">
                    <i onclick="toggleItemAvail('${i.id}', ${!i.available})" class="fas ${i.available?'fa-check-circle text-green-500':'fa-times-circle text-red-500'} text-xl cursor-pointer"></i>
                    <i onclick="delItem('${i.id}')" class="fas fa-trash text-red-500 cursor-pointer"></i>
                </div></div>`).join('');
        }
        function openMenuControl() { document.getElementById('menu-modal').classList.remove('hidden'); renderInventory(); }
        function openAddItemModal() { document.getElementById('add-item-modal').classList.add('open'); document.getElementById('new-item-name').value=''; document.getElementById('new-item-price').value=''; document.getElementById('new-item-stock').value=''; document.getElementById('new-item-img').value=''; const s = document.getElementById('new-item-cat'); s.innerHTML = currentMenuData.categories.map(c => `<option value="${c}">${c}</option>`).join(''); }
        function saveNewItem() { const n=document.getElementById('new-item-name').value, p=parseInt(document.getElementById('new-item-price').value), s=parseInt(document.getElementById('new-item-stock').value), c=document.getElementById('new-item-cat').value, img=document.getElementById('new-item-img').value; if(n&&p){ db.collection('shops').doc(SHOP_ID).collection('inventory').add({name:n, price:p, category:c||'Chai', available:true, stock:s||99, image:img}); document.getElementById('add-item-modal').classList.remove('open'); showPillToast("Added"); } }
        function toggleItemAvail(id, val) { db.collection('shops').doc(SHOP_ID).collection('inventory').doc(id).update({available: val}); }
        // NEW STOCK ADD LOGIC
        async function triggerAddStock(id) {
            const { value: qty } = await Swal.fire({ title: 'Add Stock', input: 'number', inputValue: 10, showCancelButton: true });
            if (qty) { db.collection('shops').doc(SHOP_ID).collection('inventory').doc(id).update({stock: firebase.firestore.FieldValue.increment(parseInt(qty))}); showPillToast(`Added ${qty}`); }
        }
        function delItem(id) { db.collection('shops').doc(SHOP_ID).collection('inventory').doc(id).delete(); }
        
        // --- MESSAGING ---
        function renderMessagesList() { const list = document.getElementById('messages-list'); list.innerHTML = chatUsers.map(u => `<div class="chat-row" onclick="openChat('${u.id}', '${udhaarMap[u.id]?.name || u.id}')"><div class="w-10 h-10 rounded-full bg-blue-500/20 text-blue-500 flex items-center justify-center mr-3"><i class="fas fa-user"></i></div><div><p class="font-bold text-sm text-white">${udhaarMap[u.id]?.name || "Guest"}</p><p class="text-xs text-gray-500">${u.lastMsg || 'Tap to chat'}</p></div></div>`).join(''); }
        function openChat(phone, name) { currentChatUser = phone; document.getElementById('chat-user-name').innerText = name; document.getElementById('chat-call-btn').href = `tel:${phone}`; document.getElementById('chat-screen').classList.remove('hidden'); document.getElementById('view-messages').classList.add('hidden'); db.collection('shops').doc(SHOP_ID).collection('chats').doc(phone).collection('messages').orderBy('timestamp').onSnapshot(snap => { document.getElementById('chat-bubbles').innerHTML = snap.docs.map(d => `<div class="chat-bubble ${d.data().sender === 'admin' ? 'msg-me' : 'msg-other'}">${d.data().text}</div>`).join(''); }); }
        function sendMessage() { const t = document.getElementById('chat-input').value.trim(); if (t && currentChatUser) { db.collection('shops').doc(SHOP_ID).collection('chats').doc(currentChatUser).collection('messages').add({ text: t, sender: 'admin', timestamp: firebase.firestore.FieldValue.serverTimestamp() }); db.collection('shops').doc(SHOP_ID).collection('chats').doc(currentChatUser).set({lastMsg: t}, {merge: true}); document.getElementById('chat-input').value = ""; } }

        // --- DELIVERY & REWARDS ---
        function openDeliverySettings() { db.collection('shops').doc(SHOP_ID).get().then(d => { const s = d.data().settings||{}; document.getElementById('del-min').value=s.minOrder||0; document.getElementById('del-charge').value=s.deliveryCharge||0; document.getElementById('del-free').value=s.freeDeliveryAbove||0; document.getElementById('delivery-modal').classList.add('open'); }); }
        function saveDeliverySettings() { const s = { minOrder: parseInt(document.getElementById('del-min').value), deliveryCharge: parseInt(document.getElementById('del-charge').value), freeDeliveryAbove: parseInt(document.getElementById('del-free').value) }; db.collection('shops').doc(SHOP_ID).set({settings: s}, {merge:true}); document.getElementById('delivery-modal').classList.remove('open'); showPillToast("Saved"); }
        function openRewardsModal() { renderCoupons(); document.getElementById('rewards-modal').classList.add('open'); }
        function createCoupon() { const code = document.getElementById('coup-code').value.trim().toUpperCase(), amt = parseInt(document.getElementById('coup-amt').value), isNew = document.getElementById('coup-new').checked; if(code && amt) { db.collection('shops').doc(SHOP_ID).collection('coupons').doc(code).set({code, discount:amt, newCustomerOnly:isNew}); showPillToast("Created"); renderCoupons(); } }
        function renderCoupons() { db.collection('shops').doc(SHOP_ID).collection('coupons').get().then(s => { document.getElementById('coupons-list').innerHTML = s.docs.map(d => `<div class="flex justify-between items-center bg-gray-800 p-2 rounded border border-gray-700 mt-2"><span class="text-sm font-bold text-white">${d.id} <span class="text-orange-400">₹${d.data().discount}</span></span><button onclick="db.collection('shops').doc('${SHOP_ID}').collection('coupons').doc('${d.id}').delete().then(()=>renderCoupons())" class="text-red-500"><i class="fas fa-trash"></i></button></div>`).join(''); }); }

        // --- UDHAAR ---
        function openLimitModal(p, n){ currentLimitPhone = p; document.getElementById('limit-name').innerText = n; document.getElementById('limit-input').value = ''; document.getElementById('limit-modal').classList.add('open'); }
        function saveLimit(){ db.collection('shops').doc(SHOP_ID).collection('user_limits').doc(currentLimitPhone).set({limit: parseInt(document.getElementById('limit-input').value)}, {merge: true}); document.getElementById('limit-modal').classList.remove('open'); showPillToast("Saved"); }
        function renderUdhaar() { const list = document.getElementById('udhaar-list'), q = document.getElementById('search-udhaar').value.toLowerCase(); let h = ''; for(let ph in udhaarMap) { const d = udhaarMap[ph].debit - (udhaarMap[ph].credit||0); if(d>0 && udhaarMap[ph].name.toLowerCase().includes(q)) h += `<div class="aesthetic-card p-3 mb-2"><div class="flex justify-between items-start mb-2"><div><div class="flex gap-2 items-center"><p class="font-bold text-white">${udhaarMap[ph].name}</p><i class="fas fa-lock text-gray-500 cursor-pointer text-xs hover:text-white" onclick="openLimitModal('${ph}','${udhaarMap[ph].name}')"></i></div><p class="text-xs opacity-50">${ph}</p></div><div class="text-right"><p class="font-bold text-red-400">₹${d}</p><button onclick="openSettle('${ph}','${udhaarMap[ph].name}',${d})" class="bg-blue-600 px-3 py-1 rounded text-xs text-white mt-1 font-bold">SETTLE</button></div></div></div>`; } list.innerHTML = h; }
        
        // --- UTILS ---
        function toggleShopStatus() { const btn = document.getElementById('shop-toggle-btn'), isOpen = btn.innerText === "OPEN"; db.collection('shops').doc(SHOP_ID).update({isOpen: !isOpen}); }
        function updateShopStatusUI(isOpen) { const btn = document.getElementById('shop-toggle-btn'); btn.innerText = isOpen ? "OPEN" : "CLOSED"; btn.className = isOpen ? "px-3 py-1 rounded text-xs font-bold bg-green-600 text-white shadow" : "px-3 py-1 rounded text-xs font-bold bg-red-600 text-white shadow"; }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('sidebar-overlay').classList.toggle('open'); }
        
        // New Aesthetic Toast
        function showPillToast(msg) { 
            const t = document.getElementById('custom-toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2500);
        }

        function enableAudio() { if(!soundEnabled) { soundEnabled = true; updateSoundUI(); } if(isRinging) { audioEl.pause(); audioEl.currentTime=0; isRinging=false; updateSoundUI(); } }
        function playAlarm() { if(soundEnabled && !isRinging) { audioEl.src = "https://assets.mixkit.co/active_storage/sfx/2865/2865-preview.mp3"; audioEl.loop = true; audioEl.play().catch(e=>{}); isRinging=true; updateSoundUI(); } }
        function toggleSound() { soundEnabled = !soundEnabled; updateSoundUI(); showPillToast(soundEnabled?"Sound ON":"Sound MUTED"); }
        function updateSoundUI() { const txt = soundEnabled?"ON":"OFF"; document.getElementById('sound-status').innerText = isRinging?"RINGING!":"Sound: "+txt; document.getElementById('sidebar-sound-status').innerText = txt; }
        function switchView(v) { 
            ['live','history','udhaar','messages'].forEach(x => { document.getElementById('view-'+x).classList.add('hidden'); }); 
            if(v === 'messages') { document.getElementById('view-messages').classList.remove('hidden'); }
            else { 
                document.getElementById('view-'+v).classList.remove('hidden'); 
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
                if(document.getElementById('tab-'+v)) document.getElementById('tab-'+v).classList.add('tab-active');
            }
            if(v==='history') renderHistory(); if(v==='udhaar') renderUdhaar(); if(v==='messages') renderMessagesList();
        }
        function renderHistory() { const list = document.getElementById('history-list'), q = document.getElementById('search-history').value.toLowerCase(); list.innerHTML = allOrders.filter(o => ['completed','rejected'].includes(o.status) && o.customerName.toLowerCase().includes(q)).map(o => `<div class="aesthetic-card p-3 flex justify-between"><div><span class="font-bold block">${o.customerName}</span><span class="text-xs text-gray-500">${new Date(o.timestamp.toDate()).toLocaleDateString()}</span></div><div class="text-right"><span class="font-bold block text-orange-400">₹${o.totalAmount}</span><span class="text-[10px] uppercase font-bold ${o.status==='completed'?'text-green-500':'text-red-500'}">${o.status}</span></div></div>`).join(''); }
        function setShopLocation() { showPillToast("Detecting..."); navigator.geolocation.getCurrentPosition(p => { db.collection('shops').doc(SHOP_ID).update({location: {lat: p.coords.latitude, lng: p.coords.longitude}}).then(() => showPillToast("Location Updated!")); }, e => showPillToast("Error")); }
        function openSalesAnalysis(){ document.getElementById('sales-modal').classList.remove('hidden'); document.getElementById('an-sales').innerText = document.getElementById('total-sales').dataset.realValue; document.getElementById('an-count').innerText = todaysOrderCount; document.getElementById('today-breakdown-list').innerHTML = Object.entries(todaysItemsMap).map(([n, q]) => `<div class="flex justify-between p-2 border-b border-gray-800"><span class="text-white text-sm">${n}</span><span class="text-orange-400 font-bold">${q}</span></div>`).join(''); }
        function openPrompt(t,p,c){ document.getElementById('prompt-title').innerText=t; document.getElementById('prompt-input').placeholder=p; document.getElementById('custom-prompt').classList.add('open'); promptCallback=c; }
        let promptCallback = null; document.getElementById('prompt-confirm-btn').onclick = () => { if(promptCallback) promptCallback(document.getElementById('prompt-input').value); document.getElementById('custom-prompt').classList.remove('open'); };
        function openSettle(p, n, d){ currentSettlePhone = p; document.getElementById('settle-name').innerText = n; document.getElementById('settle-due').innerText = d; document.getElementById('settle-amount').value = ''; document.getElementById('settle-modal').classList.add('open'); }
        function submitPayment(){ const a = parseInt(document.getElementById('settle-amount').value); if (a) db.collection('payments').add({phone: currentSettlePhone, amount: a, shopId: SHOP_ID, timestamp: firebase.firestore.FieldValue.serverTimestamp()}); document.getElementById('settle-modal').classList.remove('open'); showPillToast("Settled"); }
        function openPaymentLogs(){ const l = document.getElementById('logs-list'); db.collection('payments').where('shopId','==',SHOP_ID).orderBy('timestamp','desc').get().then(s => { l.innerHTML = s.docs.map(d=> `<div class="aesthetic-card p-3 mb-2 flex justify-between"><span>${d.data().phone}</span><span class="text-green-400">+₹${d.data().amount}</span></div>`).join(''); }); document.getElementById('logs-modal').classList.remove('hidden'); }
        function toggleTheme() { document.body.classList.toggle('light-mode'); document.getElementById('theme-icon').className = document.body.classList.contains('light-mode') ? "fas fa-toggle-off text-gray-400" : "fas fa-toggle-on text-purple-500"; }

        // Window Exports
        window.handleLogin = handleLogin; window.handleRegister = handleRegister; window.toggleAuth = toggleAuth; window.logout = logout; window.toggleShopStatus = toggleShopStatus; window.toggleSound = toggleSound; window.openDeliverySettings = openDeliverySettings; window.saveDeliverySettings = saveDeliverySettings; window.openRewardsModal = openRewardsModal; window.createCoupon = createCoupon; window.switchView = switchView; window.openMenuControl = openMenuControl; window.openAddItemModal = openAddItemModal; window.saveNewItem = saveNewItem; window.openPaymentLogs = openPaymentLogs; window.toggleTheme = toggleTheme; window.setShopLocation = setShopLocation; window.openSalesAnalysis = openSalesAnalysis; window.toggleSidebar = toggleSidebar; window.closeFullModal = closeFullModal; window.updateStatus = updStatus; window.deleteOrder = deleteOrder; window.openLimitModal = openLimitModal; window.saveLimit = saveLimit; window.openSettle = openSettle; window.submitPayment = submitPayment; window.openPrompt = openPrompt; window.toggleItemAvail = toggleItemAvail; window.delItem = delItem; window.triggerAddStock = triggerAddStock; window.openFullModal = openFullModal; window.openChat = openChat; window.sendMessage = sendMessage; window.closeChatWindow = () => document.getElementById('chat-screen').classList.add('hidden');
    </script>
</body>
</html>
