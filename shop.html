<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendor Partner - Nearby Bazar</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* SGMC Dark Theme Base */
        :root { --bg: #050505; --card: #141414; --border: #333; --accent: #F97316; --text: #fff; }
        body { background-color: var(--bg); color: var(--text); font-family: sans-serif; padding-bottom: 80px; }
        
        .aesthetic-card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 16px; margin-bottom: 12px; }
        
        /* Login Modal (Full Screen) */
        #auth-screen { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; padding: 20px; }
        
        input { background: #222; border: 1px solid #444; color: white; padding: 12px; width: 100%; border-radius: 10px; margin-bottom: 10px; outline: none; }
        input:focus { border-color: var(--accent); }
        
        /* Status Pills */
        .status-pending { background: rgba(234, 179, 8, 0.2); color: #fbbf24; border: 1px solid rgba(234, 179, 8, 0.3); padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; animation: pulse 2s infinite; }
        .status-ready { background: rgba(34, 197, 94, 0.2); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.3); padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; }
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(234, 179, 8, 0); } 100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); } }

        /* Sidebar & Modals from SGMC */
        .sidebar { position: fixed; top: 0; right: 0; bottom: 0; width: 280px; background: var(--bg); z-index: 100; transform: translateX(100%); transition: 0.3s; border-left: 1px solid var(--border); }
        .sidebar.open { transform: translateX(0); }
        .fs-modal { position: fixed; inset: 0; background: var(--bg); z-index: 120; transform: translateY(100%); transition: 0.3s; overflow-y: auto; padding: 20px; }
        .fs-modal.open { transform: translateY(0); }
        .popup-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 150; display: none; align-items: center; justify-content: center; }
        .popup-modal.open { display: flex; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-orange-500 mb-2">Nearby Bazar</h1>
            <p class="text-gray-500 text-sm">Vendor Partner App</p>
        </div>

        <div id="login-form">
            <input type="text" id="login-id" placeholder="Shop ID (e.g. gupta01)">
            <input type="password" id="login-pass" placeholder="Password">
            <button onclick="login()" class="w-full bg-orange-600 text-white py-3 rounded-xl font-bold mb-4">Login to Shop</button>
            <p class="text-center text-gray-500 text-xs mt-4">New here? <span onclick="toggleAuthMode('register')" class="text-blue-400 cursor-pointer">Register Shop</span></p>
        </div>

        <div id="register-form" class="hidden">
            <input type="text" id="reg-name" placeholder="Shop Name (e.g. Gupta Chai)">
            <input type="text" id="reg-owner" placeholder="Owner Name">
            <input type="tel" id="reg-phone" placeholder="Phone Number">
            <input type="text" id="reg-id" placeholder="Create Shop ID (Unique)">
            <input type="password" id="reg-pass" placeholder="Create Password">
            <input type="text" id="reg-upi" placeholder="UPI ID (for payments)">
            <button onclick="registerShop()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold mb-4">Submit Application</button>
            <p class="text-center text-gray-500 text-xs mt-4">Already have ID? <span onclick="toggleAuthMode('login')" class="text-blue-400 cursor-pointer">Login</span></p>
        </div>
    </div>

    <div id="main-app" class="hidden p-2">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl font-bold text-orange-500" id="dash-shop-name">My Shop</h1>
                <p class="text-[10px] text-green-500 font-bold uppercase tracking-wider">● LIVE DASHBOARD</p>
            </div>
            <div class="flex gap-3">
                <button onclick="toggleSound()" class="w-10 h-10 rounded-full border border-gray-700 flex items-center justify-center text-white">
                    <i id="sound-icon" class="fas fa-volume-up"></i>
                </button>
                <button onclick="toggleSidebar()" class="w-10 h-10 rounded-full border border-gray-700 flex items-center justify-center text-white">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>

        <div id="sidebar" class="sidebar p-6 flex flex-col h-full">
            <h2 class="text-xl font-bold text-orange-500 mb-8">Menu</h2>
            <div class="space-y-3">
                <div class="aesthetic-card p-3 flex justify-between items-center">
                    <span>Status</span>
                    <button id="shop-toggle-btn" onclick="toggleShopStatus()" class="px-3 py-1 rounded text-xs font-bold bg-green-600 text-white">OPEN</button>
                </div>
                <button onclick="openMenuControl(); toggleSidebar()" class="w-full text-left p-3 rounded-xl border border-gray-800 text-sm font-bold text-white"><i class="fas fa-boxes text-orange-400 mr-2"></i> Inventory</button>
                <button onclick="logout()" class="w-full text-left p-3 rounded-xl border border-red-900/50 bg-red-900/10 text-red-400 text-sm font-bold mt-auto"><i class="fas fa-sign-out-alt mr-2"></i> Logout</button>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="aesthetic-card text-center">
                <span class="text-xs uppercase text-gray-500">Revenue</span>
                <h2 class="text-2xl font-bold text-green-500 mt-1">₹<span id="today-sales">0</span></h2>
            </div>
            <div class="aesthetic-card text-center">
                <span class="text-xs uppercase text-gray-500">Active</span>
                <h2 class="text-3xl font-bold text-yellow-500 mt-1" id="pending-count">0</h2>
            </div>
        </div>

        <div id="live-orders" class="space-y-3 pb-20"></div>
    </div>

    <div id="menu-modal" class="fs-modal">
        <div class="flex justify-between items-center mb-6">
            <h3 class="font-bold text-xl">Inventory</h3>
            <button onclick="document.getElementById('menu-modal').classList.remove('open')"><i class="fas fa-times"></i></button>
        </div>
        <div id="menu-list" class="space-y-2 mb-4"></div>
        <button onclick="openAddItem()" class="w-full bg-orange-600 text-white py-3 rounded-xl font-bold">Add Item</button>
    </div>

    <div id="add-item-popup" class="popup-modal">
        <div class="aesthetic-card w-full max-w-xs p-6">
            <h3 class="font-bold mb-4">New Item</h3>
            <input id="new-name" placeholder="Item Name">
            <input id="new-price" type="number" placeholder="Price">
            <input id="new-cat" placeholder="Category (Chai, Snacks)">
            <div class="flex gap-2 mt-4">
                <button onclick="document.getElementById('add-item-popup').classList.remove('open')" class="flex-1 bg-gray-800 py-2 rounded">Cancel</button>
                <button onclick="saveNewItem()" class="flex-1 bg-orange-600 py-2 rounded font-bold text-white">Save</button>
            </div>
        </div>
    </div>

    <audio id="order-sound"></audio>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBadYpoNTL0dHkBQO4UddRVtPIfUOlf-bA", authDomain: "sgmc-16568.firebaseapp.com", projectId: "sgmc-16568", storageBucket: "sgmc-16568.firebasestorage.app", messagingSenderId: "339041646158", appId: "1:339041646158:web:85d9a50a3b51b30aae351f", measurementId: "G-4996NPF55N" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let SHOP_ID = localStorage.getItem('nb_shop_id');
        let soundEnabled = true;
        let isRinging = false;
        const audioEl = document.getElementById('order-sound');

        // --- AUTH SYSTEM ---
        function checkAuth() {
            if(SHOP_ID) {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                initShop();
            }
        }

        function toggleAuthMode(mode) {
            document.getElementById('login-form').classList.toggle('hidden', mode === 'register');
            document.getElementById('register-form').classList.toggle('hidden', mode === 'login');
        }

        function login() {
            const id = document.getElementById('login-id').value.trim();
            const pass = document.getElementById('login-pass').value.trim();
            if(!id || !pass) return alert("Enter details");

            db.collection('shops').doc(id).get().then(doc => {
                if(doc.exists && doc.data().password === pass) {
                    if(doc.data().status === 'suspended') return alert("This shop is suspended by Superadmin.");
                    if(doc.data().status === 'pending') return alert("Verification Pending. Wait for approval.");
                    
                    localStorage.setItem('nb_shop_id', id);
                    SHOP_ID = id;
                    checkAuth();
                } else {
                    alert("Invalid ID or Password");
                }
            }).catch(e => alert(e.message));
        }

        function registerShop() {
            const data = {
                shopName: document.getElementById('reg-name').value,
                ownerName: document.getElementById('reg-owner').value,
                phone: document.getElementById('reg-phone').value,
                shopId: document.getElementById('reg-id').value.trim(),
                password: document.getElementById('reg-pass').value,
                upiId: document.getElementById('reg-upi').value,
                status: 'pending',
                isOpen: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if(!data.shopId || !data.password) return alert("Fill all fields");

            db.collection('shops').doc(data.shopId).set(data)
                .then(() => {
                    // Create empty menu structure
                    db.collection('shops').doc(data.shopId).collection('menu').doc('items').set({customItems:[]});
                    alert("Application Sent! Wait for Superadmin approval.");
                    toggleAuthMode('login');
                })
                .catch(e => alert("Error: " + e.message));
        }

        function logout() {
            localStorage.removeItem('nb_shop_id');
            location.reload();
        }

        // --- SHOP LOGIC ---
        function initShop() {
            // Load Shop Details
            db.collection('shops').doc(SHOP_ID).onSnapshot(doc => {
                if(doc.exists) {
                    const s = doc.data();
                    if(s.status === 'suspended') { alert("Shop Suspended!"); logout(); }
                    document.getElementById('dash-shop-name').innerText = s.shopName;
                    updateShopStatusUI(s.isOpen);
                }
            });

            // Listen for Orders (Filtered by Shop ID)
            // Querying 'orders' collection where shopId matches
            // NOTE: In SGMC we used root 'orders', here we assume same but filtered.
            // If you change architecture, change this query.
            db.collection('orders').where('shopId', '==', SHOP_ID).orderBy('timestamp', 'desc').onSnapshot(snap => {
                renderOrders(snap);
            });
        }

        function renderOrders(snap) {
            const list = document.getElementById('live-orders');
            list.innerHTML = "";
            let active = 0, sales = 0;

            snap.forEach(doc => {
                const d = doc.data();
                if(d.status === 'delivered' || d.status === 'completed') {
                    sales += parseInt(d.totalAmount);
                } else if(d.status !== 'cancelled' && d.status !== 'rejected') {
                    active++;
                    const itemNames = d.items.map(i => `${i.qty} x ${i.name}`).join(', ');
                    
                    list.innerHTML += `
                    <div class="aesthetic-card">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h3 class="font-bold text-lg text-white">${d.customerName}</h3>
                                <p class="text-xs text-gray-400">${itemNames}</p>
                            </div>
                            <span class="status-pending">${d.status}</span>
                        </div>
                        <div class="flex justify-between items-center mt-3">
                            <span class="text-orange-500 font-bold text-xl">₹${d.totalAmount}</span>
                            <div class="flex gap-2">
                                ${d.status === 'pending' ? 
                                `<button onclick="updateOrderStatus('${doc.id}', 'cooking')" class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold">Accept</button>
                                 <button onclick="updateOrderStatus('${doc.id}', 'rejected')" class="bg-red-600 text-white px-3 py-1 rounded text-xs font-bold">Reject</button>` : 
                                 d.status === 'cooking' ? 
                                 `<button onclick="updateOrderStatus('${doc.id}', 'ready')" class="bg-yellow-600 text-white px-3 py-1 rounded text-xs font-bold">Ready</button>` :
                                 `<button onclick="updateOrderStatus('${doc.id}', 'completed')" class="bg-green-600 text-white px-3 py-1 rounded text-xs font-bold">Complete</button>`
                                }
                            </div>
                        </div>
                    </div>`;
                }
            });

            document.getElementById('pending-count').innerText = active;
            document.getElementById('today-sales').innerText = sales;

            if(active > 0) playAlarm();
        }

        function updateOrderStatus(oid, status) {
            db.collection('orders').doc(oid).update({status: status});
        }

        // --- INVENTORY ---
        function openMenuControl() {
            document.getElementById('menu-modal').classList.add('open');
            db.collection('shops').doc(SHOP_ID).collection('menu').doc('items').onSnapshot(doc => {
                const items = doc.exists ? doc.data().customItems || [] : [];
                document.getElementById('menu-list').innerHTML = items.map((i, idx) => `
                    <div class="aesthetic-card flex justify-between items-center p-3 mb-2">
                        <div>
                            <p class="font-bold text-white">${i.name}</p>
                            <p class="text-xs text-gray-400">₹${i.price}</p>
                        </div>
                        <button onclick="deleteMenuItem(${idx})" class="text-red-500"><i class="fas fa-trash"></i></button>
                    </div>
                `).join('');
            });
        }

        function openAddItem() { document.getElementById('add-item-popup').classList.add('open'); }
        
        function saveNewItem() {
            const name = document.getElementById('new-name').value;
            const price = parseInt(document.getElementById('new-price').value);
            const cat = document.getElementById('new-cat').value;
            
            if(name && price) {
                const ref = db.collection('shops').doc(SHOP_ID).collection('menu').doc('items');
                db.runTransaction(async (t) => {
                    const doc = await t.get(ref);
                    const data = doc.exists ? doc.data().customItems || [] : [];
                    data.push({id: Date.now(), name, price, category: cat, available: true});
                    t.set(ref, {customItems: data}, {merge: true});
                }).then(() => {
                    document.getElementById('add-item-popup').classList.remove('open');
                });
            }
        }

        function deleteMenuItem(idx) {
            const ref = db.collection('shops').doc(SHOP_ID).collection('menu').doc('items');
            db.runTransaction(async (t) => {
                const doc = await t.get(ref);
                const data = doc.data().customItems;
                data.splice(idx, 1);
                t.update(ref, {customItems: data});
            });
        }

        // --- UTILS ---
        function toggleShopStatus() {
            const btn = document.getElementById('shop-toggle-btn');
            const isOpen = btn.innerText === "OPEN";
            db.collection('shops').doc(SHOP_ID).update({isOpen: !isOpen});
        }

        function updateShopStatusUI(isOpen) {
            const btn = document.getElementById('shop-toggle-btn');
            btn.innerText = isOpen ? "OPEN" : "CLOSED";
            btn.className = isOpen ? "px-3 py-1 rounded text-xs font-bold bg-green-600 text-white" : "px-3 py-1 rounded text-xs font-bold bg-red-600 text-white";
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
        
        function playAlarm() { 
            if(soundEnabled && !isRinging) { 
                audioEl.src = "https://assets.mixkit.co/active_storage/sfx/2865/2865-preview.mp3"; 
                audioEl.loop = true; 
                audioEl.play().catch(e=>console.log(e)); 
                isRinging = true; 
                document.body.onclick = () => { audioEl.pause(); isRinging = false; };
            } 
        }
        function toggleSound() { soundEnabled = !soundEnabled; document.getElementById('sound-icon').className = soundEnabled ? "fas fa-volume-up" : "fas fa-volume-mute"; }

        checkAuth();
    </script>
</body>
</html>
