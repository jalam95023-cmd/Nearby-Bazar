<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partner App</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #F8FAFC; padding-bottom: 90px; }
        .header { background: #4F46E5; color: white; padding: 25px 20px; border-radius: 0 0 25px 25px; box-shadow: 0 5px 15px rgba(79, 70, 229, 0.3); }
        .order-card { background: white; border-radius: 16px; padding: 15px; margin-bottom: 12px; border-left: 5px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .status-new { border-left-color: #EF4444; background: #FEF2F2; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
        
        .fab { position: fixed; bottom: 100px; right: 20px; width: 60px; height: 60px; background: #4F46E5; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; box-shadow: 0 10px 20px rgba(79, 70, 229, 0.4); z-index: 100; cursor: pointer; }
        
        .nav-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #1E293B; padding: 12px 30px; border-radius: 40px; display: flex; gap: 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 2000; }
        .nav-icon { color: rgba(255,255,255,0.5); font-size: 1.4rem; cursor: pointer; }
        .nav-icon.active { color: white; }
    </style>
</head>
<body>

    <div id="auth" class="vh-100 bg-white d-flex flex-column justify-content-center p-4" style="position:fixed; width:100%; z-index:9999;">
        <h3 class="fw-bold text-center mb-4">Partner Registration</h3>
        <input id="s-name" class="form-control mb-3" placeholder="Shop Name">
        <input id="s-owner" class="form-control mb-3" placeholder="Owner Name">
        <input id="s-phone" class="form-control mb-3" placeholder="Phone">
        <input id="s-upi" class="form-control mb-3" placeholder="UPI ID (for payments)">
        <small class="text-muted mb-2">Upload Aadhar (Simulated)</small>
        <input type="file" class="form-control mb-4" id="s-aadhar">
        <button onclick="register()" class="btn btn-primary w-100 rounded-pill fw-bold">Submit for Approval</button>
    </div>

    <div id="app" style="display:none;">
        <div class="header d-flex justify-content-between align-items-center">
            <div><h4 class="fw-bold m-0" id="shop-name">My Shop</h4><small id="status">● Online</small></div>
            <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="shutter" style="transform: scale(1.5);" onchange="toggleShutter()"></div>
        </div>

        <div id="view-orders" class="p-3">
            <h6 class="text-muted fw-bold mb-3">ORDERS</h6>
            <div id="orders-list"><div class="text-center mt-5 text-muted">No orders yet</div></div>
        </div>

        <div id="view-inventory" class="p-3" style="display:none;">
            <h6 class="text-muted fw-bold mb-3">INVENTORY</h6>
            <div id="inventory-list"></div>
        </div>
    </div>

    <div id="fab" class="fab" onclick="addItem()" style="display:none;">+</div>
    <div class="nav-bar" id="nav" style="display:none;">
        <div class="nav-icon active" onclick="switchTab('orders', this)"><i class="fas fa-list-alt"></i></div>
        <div class="nav-icon" onclick="switchTab('inventory', this)"><i class="fas fa-box"></i></div>
    </div>

    <audio id="alarm" src="https://assets.mixkit.co/active_storage/sfx/936/936-preview.mp3" loop></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, updateDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyDm_yS9tmdfnMmhoUiGwLSAnQpz5trXuko", authDomain: "nearby-bazar.firebaseapp.com", projectId: "nearby-bazar", storageBucket: "nearby-bazar.firebasestorage.app", messagingSenderId: "183262510084", appId: "1:183262510084:web:909fa3aac2f2429a7d8951" }));
        let sid = localStorage.getItem("sid");

        if(sid) { document.getElementById("auth").style.display='none'; document.getElementById("app").style.display='block'; document.getElementById("nav").style.display='flex'; init(); }

        window.register = async () => {
            const name = document.getElementById("s-name").value;
            const upi = document.getElementById("s-upi").value;
            if(!name) return Swal.fire("Error","Name Required","error");
            
            navigator.geolocation.getCurrentPosition(async (p) => {
                const ref = await addDoc(collection(db, "shops"), {
                    shopName: name, ownerName: document.getElementById("s-owner").value,
                    phone: document.getElementById("s-phone").value, upiId: upi,
                    aadharUrl: "file_uploaded_dummy.pdf", // Simulated
                    lat: p.coords.latitude, lng: p.coords.longitude,
                    status: 'pending', isOpen: true
                });
                localStorage.setItem("sid", ref.id); location.reload();
            });
        };

        function init() {
            onSnapshot(doc(db, "shops", sid), (d) => {
                const s = d.data();
                document.getElementById("shop-name").innerText = s.shopName;
                document.getElementById("shutter").checked = s.isOpen;
                document.getElementById("status").innerText = s.isOpen ? "● Online" : "● Offline";
            });

            onSnapshot(query(collection(db, "orders"), where("shopId", "==", sid)), (snap) => {
                const div = document.getElementById("orders-list"); div.innerHTML = "";
                let hasNew = false;
                snap.forEach(d => {
                    const o = d.data();
                    if(o.status === 'delivered') return;
                    let btn = "";
                    if(o.status === 'new') {
                        hasNew = true;
                        btn = `<div class="d-flex gap-2 mt-2"><button onclick="upd('${d.id}','preparing')" class="btn btn-success w-100">Accept</button><button onclick="upd('${d.id}','rejected')" class="btn btn-outline-danger w-100">Reject</button></div>`;
                    } else if (o.status === 'preparing') btn = `<button onclick="upd('${d.id}','ready')" class="btn btn-warning w-100 mt-2">Mark Ready</button>`;
                    else if (o.status === 'ready') btn = `<button onclick="verify('${d.id}', '${o.otp}')" class="btn btn-dark w-100 mt-2">Verify OTP</button>`;

                    div.innerHTML += `<div class="order-card ${o.status=='new'?'status-new':''}">
                        <div class="d-flex justify-content-between"><strong>${o.customerName}</strong><span class="badge bg-dark">₹${o.totalAmount}</span></div>
                        <small class="text-muted">${o.items.map(i=>i.name).join(', ')}</small>
                        <div class="mt-1 small fw-bold text-primary">Mode: ${o.paymentMode || 'Cash'}</div>
                        ${btn}
                    </div>`;
                });
                const a = document.getElementById("alarm");
                if(hasNew) a.play().catch(e=>console.log("Audio block")); else { a.pause(); a.currentTime=0; }
            });

            onSnapshot(collection(db, `shops/${sid}/inventory`), (snap) => {
                const div = document.getElementById("inventory-list"); div.innerHTML = "";
                snap.forEach(d => {
                    div.innerHTML += `<div class="bg-white p-3 rounded-4 mb-2 shadow-sm d-flex justify-content-between align-items-center">
                        <div><strong>${d.data().name}</strong><br>₹${d.data().price}</div><button onclick="del('${d.id}')" class="btn btn-sm text-danger"><i class="fas fa-trash"></i></button></div>`;
                });
            });
        }

        window.toggleShutter = async () => updateDoc(doc(db, "shops", sid), { isOpen: document.getElementById("shutter").checked });
        window.upd = async (id, s) => updateDoc(doc(db, "orders", id), { status: s });
        window.verify = async (id, otp) => {
            const {value: v} = await Swal.fire({title:'Enter OTP', input:'text'});
            if(v == otp) { await updateDoc(doc(db, "orders", id), { status: 'delivered' }); Swal.fire("Done","Delivered","success"); }
            else Swal.fire("Wrong","","error");
        };
        window.addItem = async () => {
            const {value: f} = await Swal.fire({title:'Add', html:'<input id="n" class="swal2-input" placeholder="Name"><input id="p" class="swal2-input" placeholder="Price">', preConfirm:()=>[document.getElementById('n').value,document.getElementById('p').value]});
            if(f) addDoc(collection(db, `shops/${sid}/inventory`), {name:f[0], price:f[1]});
        };
        window.del = async (id) => deleteDoc(doc(db, `shops/${sid}/inventory`, id));
        window.switchTab = (t, e) => {
            document.getElementById("view-orders").style.display='none'; document.getElementById("view-inventory").style.display='none';
            document.getElementById("fab").style.display = t==='inventory'?'flex':'none';
            document.getElementById("view-"+t).style.display='block';
        };
    </script>
</body>
</html>
