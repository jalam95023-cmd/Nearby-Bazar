<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Now</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #F8FAFC; padding-bottom: 100px; }
        .header { background: white; padding: 20px; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .shop-card { background: white; border-radius: 16px; padding: 15px; margin-bottom: 15px; border: 1px solid #eee; display: flex; align-items: center; cursor: pointer; }
        .menu-sheet { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; overflow-y: auto; display: none; }
        .cart-float { position: fixed; bottom: 25px; left: 5%; width: 90%; background: #111; color: white; padding: 18px 25px; border-radius: 20px; display: flex; justify-content: space-between; font-weight: bold; cursor: pointer; display: none; z-index: 3000; }
        
        /* Tracker */
        #tracker { background: #FEF3C7; color: #92400E; padding: 15px; border-radius: 12px; margin-bottom: 20px; display: none; border-left: 5px solid #F59E0B; }
    </style>
</head>
<body>

    <div id="home">
        <div class="header">
            <h5 class="fw-bold m-0"><i class="fas fa-map-marker-alt text-danger"></i> Nearby Bazar</h5>
            <input type="text" class="form-control mt-3 rounded-pill bg-light border-0" placeholder="Search chai, food..." onkeyup="filter(this.value)">
        </div>
        <div class="container mt-4">
            <div id="tracker">
                <div class="d-flex justify-content-between"><strong><i class="fas fa-clock"></i> Active Order</strong><span id="t-status">Preparing...</span></div>
                <div class="mt-2">OTP: <strong id="t-otp" class="fs-5">--</strong></div>
                <button class="btn btn-sm btn-outline-danger mt-2 w-100" onclick="reportIssue()">Report: Item Not Received</button>
            </div>
            <h6 class="text-muted fw-bold mb-3">AVAILABLE SHOPS</h6>
            <div id="shops">Loading...</div>
        </div>
    </div>

    <div id="menu" class="menu-sheet">
        <div class="p-3 shadow-sm sticky-top bg-white d-flex align-items-center">
            <button class="btn btn-light rounded-circle me-3" onclick="closeMenu()"><i class="fas fa-arrow-left"></i></button>
            <h5 class="m-0 fw-bold" id="m-title">Shop</h5>
        </div>
        <div class="container mt-3" id="m-list"></div>
        <div style="height:100px;"></div>
    </div>

    <div id="cart-btn" class="cart-float" onclick="checkout()">
        <span><span id="c-count">0</span> Items</span><span>Place Order <i class="fas fa-arrow-right"></i></span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, getDocs, addDoc, query, where } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyDm_yS9tmdfnMmhoUiGwLSAnQpz5trXuko", authDomain: "nearby-bazar.firebaseapp.com", projectId: "nearby-bazar", storageBucket: "nearby-bazar.firebasestorage.app", messagingSenderId: "183262510084", appId: "1:183262510084:web:909fa3aac2f2429a7d8951" }));
        
        let curShop = null, cart = [], total = 0, lastOid = localStorage.getItem("lastOid");

        // 1. Load Shops (List View)
        onSnapshot(collection(db, "shops"), (snap) => {
            const div = document.getElementById("shops"); div.innerHTML = "";
            let found = false;
            snap.forEach(d => {
                const s = d.data();
                if(s.status === 'verified') {
                    found = true;
                    const op = s.isOpen ? 1 : 0.6;
                    div.innerHTML += `<div class="shop-card shop-item" style="opacity:${op}" onclick="openShop('${d.id}','${s.shopName}', ${s.isOpen})">
                        <div class="bg-light rounded p-3 me-3 fs-3">üè™</div>
                        <div><h6 class="fw-bold m-0">${s.shopName}</h6><small class="text-muted">${s.isOpen?'Open':'Closed'}</small></div>
                    </div>`;
                }
            });
            if(!found) div.innerHTML = "<p class='text-center text-muted'>No shops nearby.</p>";
        });

        if(lastOid) track(lastOid);

        function track(id) {
            onSnapshot(query(collection(db, "orders"), where("__name__", "==", id)), (snap) => {
                if(!snap.empty) {
                    const d = snap.docs[0].data();
                    document.getElementById("tracker").style.display = 'block';
                    document.getElementById("t-status").innerText = d.status.toUpperCase();
                    document.getElementById("t-otp").innerText = d.otp;
                    if(d.status === 'delivered') { setTimeout(()=>{document.getElementById("tracker").style.display='none'; localStorage.removeItem("lastOid");}, 5000); }
                }
            });
        }

        window.openShop = async (id, name, open) => {
            if(!open) return Swal.fire("Closed","Shop is offline","info");
            curShop = id; document.getElementById("m-title").innerText = name;
            document.getElementById("home").style.display='none'; document.getElementById("menu").style.display='block';
            const list = document.getElementById("m-list"); list.innerHTML = "Loading...";
            const items = await getDocs(collection(db, `shops/${id}/inventory`));
            list.innerHTML = "";
            items.forEach(d => {
                const i = d.data();
                list.innerHTML += `<div class="d-flex justify-content-between mb-3 border-bottom pb-2">
                    <div><strong>${i.name}</strong><br>‚Çπ${i.price}</div>
                    <button class="btn btn-sm btn-outline-dark" onclick="add('${i.name}',${i.price})">ADD</button>
                </div>`;
            });
        };

        window.add = (n, p) => { cart.push({name:n, price:p}); total+=parseInt(p); updCart(); };
        function updCart() {
            document.getElementById("c-count").innerText = cart.length;
            document.getElementById("cart-btn").style.display = cart.length?'flex':'none';
        }

        window.checkout = async () => {
            const { value: mode } = await Swal.fire({ title: 'Payment Mode', input: 'select', inputOptions: { 'Cash': 'Cash', 'Udhar': 'Udhar (Credit)' }, showCancelButton: true });
            if(mode) {
                const otp = Math.floor(1000 + Math.random() * 9000);
                const ref = await addDoc(collection(db, "orders"), {
                    shopId: curShop, items: cart, totalAmount: total, otp: otp,
                    status: 'new', customerName: 'Guest User', paymentMode: mode, disputeStatus: 'none', timestamp: new Date()
                });
                localStorage.setItem("lastOid", ref.id);
                track(ref.id);
                window.closeMenu();
                Swal.fire("Order Placed", `OTP: ${otp}`, "success");
            }
        };

        window.reportIssue = async () => {
            if(confirm("Report to Admin?")) {
                await updateDoc(doc(db, "orders", lastOid), { disputeStatus: 'active' });
                Swal.fire("Reported", "Admin will contact you.", "warning");
            }
        };

        window.closeMenu = () => { document.getElementById("menu").style.display='none'; document.getElementById("home").style.display='block'; cart=[]; total=0; updCart(); };
        window.filter = (v) => { Array.from(document.getElementsByClassName('shop-item')).forEach(e => e.style.display = e.innerText.toLowerCase().includes(v.toLowerCase())?'flex':'none'); };
    </script>
</body>
</html>
