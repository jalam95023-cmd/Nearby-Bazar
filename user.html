<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nearby Bazar</title>
    <meta name="theme-color" content="#0f0f0f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* --- SGMC DARK THEME --- */
        :root { --bg: #050505; --card: #141414; --border: #333; --accent: #F97316; --text: #fff; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; padding-bottom: 80px; -webkit-tap-highlight-color: transparent; }
        
        .glass-card { background: rgba(30, 30, 30, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 16px; }
        .shop-card { background: #1a1a1a; border: 1px solid #333; border-radius: 16px; padding: 16px; margin-bottom: 12px; transition: 0.2s; position: relative; overflow: hidden; }
        .shop-card:active { transform: scale(0.98); }
        
        /* Sidebars */
        .sidebar { position: fixed; top: 0; left: 0; bottom: 0; width: 280px; background: #0f0f0f; z-index: 200; transform: translateX(-100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); border-right: 1px solid #333; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
        .sidebar.open { transform: translateX(0); }
        .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); opacity: 0; pointer-events: none; transition: 0.3s; z-index: 190; }
        .sidebar-overlay.open { opacity: 1; pointer-events: auto; }

        /* Full Screen Modals */
        .fs-modal { position: fixed; inset: 0; background: var(--bg); z-index: 100; transform: translateX(100%); transition: 0.3s; overflow-y: auto; }
        .fs-modal.open { transform: translateX(0); }
        
        /* Auth */
        #auth-screen { position: fixed; inset: 0; background: #000; z-index: 1000; display: flex; flex-direction: column; justify-content: center; padding: 24px; }
        input { background: #222; border: 1px solid #444; color: white; padding: 14px; width: 100%; border-radius: 12px; margin-bottom: 12px; outline: none; }
        .btn-primary { background: linear-gradient(to right, #ea580c, #c2410c); color: white; padding: 14px; border-radius: 12px; font-weight: bold; width: 100%; text-align: center; }

        /* Cart Bar */
        #cart-bar { position: fixed; bottom: 20px; left: 15px; right: 15px; background: linear-gradient(to right, #ea580c, #ca8a04); color: white; padding: 14px 20px; border-radius: 16px; display: none; justify-content: space-between; align-items: center; box-shadow: 0 10px 25px rgba(234, 88, 12, 0.4); z-index: 150; cursor: pointer; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Chat */
        .chat-bubble { max-width: 75%; padding: 10px 14px; border-radius: 18px; margin-bottom: 8px; font-size: 14px; }
        .msg-me { background: var(--accent); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .msg-other { background: #333; color: white; align-self: flex-start; border-bottom-left-radius: 2px; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="text-center mb-10">
            <h1 class="text-4xl font-bold text-orange-500 mb-2">Nearby Bazar</h1>
            <p class="text-gray-500 text-sm">One Login, Infinite Shops</p>
        </div>
        <input type="text" id="user-name" placeholder="Your Full Name">
        <input type="tel" id="user-phone" placeholder="Phone Number (10 digits)">
        <button onclick="login()" class="btn-primary mt-4">Continue</button>
    </div>

    <div id="view-home" class="hidden">
        <div class="sticky top-0 z-40 bg-[#050505]/95 backdrop-blur-md p-4 border-b border-[#333] flex justify-between items-center">
            <button onclick="toggleMainSidebar()" class="w-10 h-10 rounded-full bg-gray-900 border border-gray-800 text-white"><i class="fas fa-bars"></i></button>
            <div class="text-center">
                <h1 class="text-lg font-bold text-orange-500">Nearby Bazar</h1>
                <p class="text-[10px] text-gray-400" id="loc-status">Detecting Location...</p>
            </div>
            <div class="w-10"></div> </div>

        <div id="shops-container" class="p-4 space-y-3 pb-24">
            <div class="text-center text-gray-600 mt-20" id="loading-msg">
                <i class="fas fa-circle-notch fa-spin text-2xl mb-2"></i><br>Scanning Area...
            </div>
        </div>
    </div>

    <div id="view-shop" class="fs-modal p-0 bg-[#050505]">
        <div class="sticky top-0 z-40 bg-[#050505]/95 backdrop-blur-md p-4 border-b border-[#333] flex justify-between items-center">
            <button onclick="closeShop()" class="w-10 h-10 rounded-full bg-gray-900 text-gray-400"><i class="fas fa-arrow-left"></i></button>
            <h1 class="text-lg font-bold text-white truncate px-2" id="shop-title">Shop Name</h1>
            <button onclick="toggleShopSidebar()" class="w-10 h-10 rounded-full bg-gray-900 border border-gray-800 text-white"><i class="fas fa-ellipsis-v"></i></button>
        </div>

        <div id="menu-list" class="p-4 space-y-3 pb-32"></div>

        <div id="cart-bar" onclick="openCheckout()">
            <div class="flex items-center gap-3">
                <div class="bg-white text-orange-600 w-6 h-6 rounded-full flex items-center justify-center font-bold text-xs" id="cart-count">0</div>
                <div><span class="font-bold text-sm">‚Çπ<span id="cart-total">0</span></span></div>
            </div>
            <span class="font-bold text-xs">Checkout <i class="fas fa-arrow-right ml-1"></i></span>
        </div>
    </div>

    <div id="main-overlay" class="sidebar-overlay" onclick="toggleMainSidebar()"></div>
    <div id="sidebar-main" class="sidebar p-6 flex flex-col h-full">
        <div class="mb-8">
            <div class="w-16 h-16 rounded-full bg-orange-500/20 text-orange-500 flex items-center justify-center text-2xl mb-3"><i class="fas fa-user"></i></div>
            <h2 class="text-xl font-bold text-white" id="sb-name">User</h2>
            <p class="text-sm text-gray-500" id="sb-phone">+91 0000000000</p>
        </div>
        <div class="space-y-4 flex-1">
            <button onclick="showMyOrders()" class="flex items-center gap-3 text-gray-300 font-bold"><i class="fas fa-receipt w-6"></i> All Orders</button>
            <button onclick="shareApp()" class="flex items-center gap-3 text-gray-300 font-bold"><i class="fas fa-share-alt w-6"></i> Share App</button>
        </div>
        <button onclick="logout()" class="text-red-500 font-bold flex items-center gap-3 mt-auto"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>

    <div id="shop-overlay" class="sidebar-overlay" onclick="toggleShopSidebar()"></div>
    <div id="sidebar-shop" class="sidebar p-6 flex flex-col h-full" style="left:auto; right:0; transform:translateX(100%); border-left:1px solid #333; border-right:none;">
        <div class="mb-8">
            <h2 class="text-xl font-bold text-orange-500 mb-1" id="sb-shop-name">Shop Name</h2>
            <p class="text-xs text-green-500 font-bold">‚óè LIVE NOW</p>
        </div>
        <div class="space-y-4 flex-1">
            <button onclick="openChat()" class="flex items-center gap-3 text-white font-bold p-3 bg-gray-800 rounded-xl w-full"><i class="fas fa-comments text-blue-400"></i> Message Owner</button>
            <button onclick="openShopHistory()" class="flex items-center gap-3 text-gray-300 font-bold"><i class="fas fa-history w-6 text-gray-500"></i> My History</button>
            <button onclick="alert('Feature coming soon!')" class="flex items-center gap-3 text-gray-300 font-bold"><i class="fas fa-star w-6 text-yellow-500"></i> Rate Shop</button>
        </div>
    </div>

    <div id="checkout-modal" class="fixed inset-0 bg-[#050505] z-[150] hidden flex-col">
        <div class="p-4 border-b border-gray-800 flex justify-between items-center">
            <button onclick="document.getElementById('checkout-modal').classList.add('hidden')" class="text-gray-400"><i class="fas fa-times"></i></button>
            <h2 class="font-bold text-white">Checkout</h2>
            <div class="w-6"></div>
        </div>
        <div class="p-4 flex-1 overflow-y-auto">
            <div class="bg-[#141414] p-4 rounded-xl border border-[#333] mb-4">
                <div class="flex gap-2 mb-4 bg-black p-1 rounded-lg">
                    <button onclick="toggleOrderType('self')" id="btn-self" class="flex-1 py-2 rounded bg-orange-600 text-white text-xs font-bold">Self</button>
                    <button onclick="toggleOrderType('other')" id="btn-other" class="flex-1 py-2 rounded text-gray-400 text-xs font-bold">Others</button>
                </div>
                <div id="other-info" class="hidden space-y-3 mb-2">
                    <input id="rec-name" placeholder="Receiver Name" class="text-sm">
                    <input id="rec-phone" type="tel" placeholder="Receiver Phone" class="text-sm">
                </div>
                <input id="address-input" placeholder="Flat No / Landmark" class="text-sm">
            </div>

            <div class="bg-[#141414] p-4 rounded-xl border border-[#333] mb-4">
                <h3 class="font-bold text-sm text-gray-400 mb-3">Payment Method</h3>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="setPay('Cash')" id="pay-cash" class="py-3 rounded bg-gray-800 text-gray-400 text-xs font-bold border border-gray-700">Cash</button>
                    <button onclick="setPay('UPI')" id="pay-upi" class="py-3 rounded bg-gray-800 text-gray-400 text-xs font-bold border border-gray-700">UPI</button>
                    <button onclick="setPay('Udhaar')" id="pay-udhaar" class="py-3 rounded bg-gray-800 text-gray-400 text-xs font-bold border border-gray-700">Udhaar</button>
                </div>
            </div>

            <div class="bg-[#141414] p-4 rounded-xl border border-[#333] mb-4 flex justify-between items-center">
                <span class="text-gray-400 text-sm">To Pay</span>
                <span class="text-2xl font-bold text-white">‚Çπ<span id="co-total">0</span></span>
            </div>
        </div>
        <div class="p-4 bg-[#141414] border-t border-[#333]">
            <button onclick="placeOrder()" class="w-full bg-gradient-to-r from-orange-600 to-yellow-500 text-white py-4 rounded-xl font-bold shadow-lg text-lg">Confirm Order</button>
        </div>
    </div>

    <div id="chat-modal" class="fixed inset-0 bg-[#050505] z-[200] hidden flex-col">
        <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-[#141414]">
            <button onclick="document.getElementById('chat-modal').classList.add('hidden')" class="text-gray-400"><i class="fas fa-arrow-left"></i></button>
            <h3 class="font-bold text-white">Shop Support</h3>
            <div class="w-6"></div>
        </div>
        <div id="chat-box" class="flex-1 overflow-y-auto p-4 flex flex-col space-y-2"></div>
        <div class="p-3 border-t border-gray-800 flex gap-2 bg-[#141414]">
            <input type="text" id="chat-msg" placeholder="Type..." class="rounded-full px-4 text-sm bg-gray-900 border-none flex-1">
            <button onclick="sendChat()" class="w-10 h-10 bg-orange-600 rounded-full text-white flex items-center justify-center"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <div id="history-modal" class="fixed inset-0 bg-[#050505] z-[180] hidden flex-col">
        <div class="p-4 border-b border-gray-800 flex justify-between items-center">
            <button onclick="document.getElementById('history-modal').classList.add('hidden')" class="text-gray-400"><i class="fas fa-times"></i></button>
            <h2 class="font-bold text-white" id="hist-title">Orders</h2>
            <div class="w-6"></div>
        </div>
        <div id="history-list" class="p-4 space-y-3 overflow-y-auto"></div>
    </div>

    <div id="order-success" class="fixed inset-0 bg-black z-[300] hidden flex-col items-center justify-center text-center">
        <div class="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center mb-4 animate-bounce"><i class="fas fa-check text-4xl text-white"></i></div>
        <h2 class="text-2xl font-bold text-white">Order Sent!</h2>
        <p class="text-gray-400 mt-2">Waiting for shop confirmation...</p>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBadYpoNTL0dHkBQO4UddRVtPIfUOlf-bA", authDomain: "nearby-bazar.firebaseapp.com", projectId: "nearby-bazar", storageBucket: "nearby-bazar.firebasestorage.app", messagingSenderId: "183262510084", appId: "1:183262510084:web:85d9a50a3b51b30aae351f", measurementId: "G-4996NPF55N" };
        firebase.initializeApp(firebaseConfig); 
        const db = firebase.firestore();

        let USER = JSON.parse(localStorage.getItem('nb_user'));
        let currentLocation = null;
        let activeShop = null; // Currently opened shop
        let cart = [];
        let payMode = 'Cash';
        let isSelf = true;

        // --- AUTH ---
        if(USER) {
            document.getElementById('auth-screen').style.display='none';
            document.getElementById('view-home').classList.remove('hidden');
            document.getElementById('sb-name').innerText = USER.name;
            document.getElementById('sb-phone').innerText = USER.phone;
            initApp();
        } else {
            document.getElementById('auth-screen').style.display='flex';
        }

        function login() {
            const name = document.getElementById('user-name').value.trim();
            const phone = document.getElementById('user-phone').value.trim();
            if(name && phone.length === 10) {
                USER = { name, phone };
                localStorage.setItem('nb_user', JSON.stringify(USER));
                location.reload();
            } else alert("Invalid Details");
        }
        function logout() { localStorage.removeItem('nb_user'); location.reload(); }

        // --- HOME ---
        function initApp() {
            // GPS Attempt
            navigator.geolocation.getCurrentPosition(
                (p) => {
                    currentLocation = { lat: p.coords.latitude, lng: p.coords.longitude };
                    document.getElementById('loc-status').innerHTML = `<i class="fas fa-location-arrow text-blue-500"></i> GPS Connected`;
                    loadShops();
                },
                (e) => {
                    console.log("GPS Failed, showing all shops");
                    document.getElementById('loc-status').innerText = "GPS Off - Showing All Shops";
                    currentLocation = null;
                    loadShops();
                }, {timeout: 5000}
            );
        }

        function loadShops() {
            db.collection('shops').where('status', '==', 'verified').onSnapshot(snap => {
                const list = document.getElementById('shops-container');
                list.innerHTML = "";
                
                if(snap.empty) { list.innerHTML = `<div class="text-center text-gray-500 mt-20">No shops found</div>`; return; }

                snap.forEach(doc => {
                    const s = doc.data();
                    let distText = "Unknown Distance";
                    let isNearby = true;

                    // Calc Distance if GPS
                    if(currentLocation && s.location) {
                        const km = getDistance(currentLocation.lat, currentLocation.lng, s.location.lat, s.location.lng);
                        distText = km.toFixed(1) + " km away";
                        if(km > 3.0) isNearby = false; // Filter
                    }

                    // Render Card
                    // Fallback: If no location, show anyway (for testing)
                    if(true) { 
                        list.innerHTML += `
                        <div class="shop-card flex justify-between items-center" onclick="openShop('${doc.id}', '${s.shopName}')">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-full bg-gray-800 border border-gray-700 flex items-center justify-center text-2xl">üè™</div>
                                <div>
                                    <h2 class="font-bold text-white text-lg">${s.shopName}</h2>
                                    <p class="text-xs text-gray-400">${distText} ‚Ä¢ ${s.ownerName}</p>
                                </div>
                            </div>
                            <div class="flex flex-col items-end gap-1">
                                <span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${s.isOpen?'bg-green-900/40 text-green-400 border border-green-800':'bg-red-900/40 text-red-400 border border-red-800'}">
                                    ${s.isOpen ? 'OPEN' : 'CLOSED'}
                                </span>
                            </div>
                        </div>`;
                    }
                });
            });
        }

        // --- SHOP & MENU ---
        async function openShop(id, name) {
            // Fetch fresh shop data
            const docSnap = await db.collection('shops').doc(id).get();
            activeShop = { id, ...docSnap.data() };
            
            document.getElementById('shop-title').innerText = name;
            document.getElementById('sb-shop-name').innerText = name;
            document.getElementById('view-shop').classList.add('open');
            
            // Load Menu from 'inventory' collection
            db.collection('shops').doc(id).collection('inventory').where('available','==',true).onSnapshot(snap => {
                const list = document.getElementById('menu-list');
                list.innerHTML = snap.docs.map(doc => {
                    const i = doc.data();
                    return `
                    <div class="glass-card p-3 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            ${i.image ? `<img src="${i.image}" class="w-12 h-12 rounded-lg object-cover bg-gray-800">` : ''}
                            <div>
                                <h4 class="font-bold text-white text-sm">${i.name}</h4>
                                <p class="text-xs text-orange-400 font-bold">‚Çπ${i.price}</p>
                            </div>
                        </div>
                        <button onclick="addToCart('${doc.id}', '${i.name}', ${i.price})" class="bg-gray-800 text-white px-4 py-1.5 rounded-lg text-xs font-bold border border-gray-700 hover:bg-orange-600 transition">ADD</button>
                    </div>`;
                }).join('');
            });
            cart = []; updateCartUI();
        }

        function closeShop() { document.getElementById('view-shop').classList.remove('open'); }

        // --- CART ---
        function addToCart(id, name, price) {
            const exist = cart.find(x => x.id === id);
            if(exist) exist.qty++; else cart.push({id, name, price, qty: 1});
            updateCartUI();
        }
        function updateCartUI() {
            const bar = document.getElementById('cart-bar');
            const total = cart.reduce((a,b) => a+(b.price*b.qty), 0);
            const count = cart.reduce((a,b) => a+b.qty, 0);
            document.getElementById('cart-total').innerText = total;
            document.getElementById('cart-count').innerText = count;
            bar.style.display = count > 0 ? 'flex' : 'none';
        }

        // --- CHECKOUT ---
        function openCheckout() {
            const total = cart.reduce((a,b) => a+(b.price*b.qty), 0);
            document.getElementById('co-total').innerText = total;
            document.getElementById('checkout-modal').classList.remove('hidden');
            document.getElementById('checkout-modal').style.display = 'flex';
        }
        
        function toggleOrderType(t) {
            isSelf = t === 'self';
            document.getElementById('btn-self').className = isSelf ? "flex-1 py-2 rounded bg-orange-600 text-white text-xs font-bold" : "flex-1 py-2 rounded text-gray-400 text-xs font-bold";
            document.getElementById('btn-other').className = !isSelf ? "flex-1 py-2 rounded bg-orange-600 text-white text-xs font-bold" : "flex-1 py-2 rounded text-gray-400 text-xs font-bold";
            document.getElementById('other-info').classList.toggle('hidden', isSelf);
        }

        function setPay(m) {
            payMode = m;
            ['Cash','UPI','Udhaar'].forEach(x => {
                document.getElementById('pay-'+x.toLowerCase()).classList.remove('bg-green-600', 'text-white', 'border-green-500');
                document.getElementById('pay-'+x.toLowerCase()).classList.add('bg-gray-800', 'text-gray-400');
            });
            document.getElementById('pay-'+m.toLowerCase()).classList.add('bg-green-600', 'text-white', 'border-green-500');
        }

        async function placeOrder() {
            const address = document.getElementById('address-input').value;
            if(!address) return alert("Enter Address!");
            
            const total = cart.reduce((a,b) => a+(b.price*b.qty), 0);
            const recipient = isSelf ? null : { name: document.getElementById('rec-name').value, phone: document.getElementById('rec-phone').value };

            // Payment Logic (UPI Deep Link)
            if(payMode === 'UPI' && activeShop.upiId) {
                const upiLink = `upi://pay?pa=${activeShop.upiId}&pn=${activeShop.shopName}&am=${total}&cu=INR`;
                window.location.href = upiLink; 
            }

            // Save Order
            await db.collection('orders').add({
                shopId: activeShop.id,
                items: cart,
                totalAmount: total,
                paymentMode: payMode,
                status: 'pending',
                customerName: USER.name,
                customerPhone: USER.phone,
                customerAddress: address,
                customerCoordinates: currentLocation,
                recipient: recipient,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            document.getElementById('checkout-modal').classList.add('hidden');
            document.getElementById('order-success').style.display='flex';
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            
            setTimeout(() => {
                document.getElementById('order-success').style.display='none';
                closeShop();
                showMyOrders(); // Show global history
            }, 3000);
        }

        // --- SIDEBARS ---
        function toggleMainSidebar() { document.getElementById('sidebar-main').classList.toggle('open'); document.getElementById('main-overlay').classList.toggle('open'); }
        function toggleShopSidebar() { document.getElementById('sidebar-shop').classList.toggle('open'); document.getElementById('shop-overlay').classList.toggle('open'); }

        // --- HISTORY & CHAT ---
        function showMyOrders() {
            toggleMainSidebar();
            document.getElementById('hist-title').innerText = "All Orders";
            renderHistoryQuery(db.collection('orders').where('customerPhone', '==', USER.phone).orderBy('timestamp', 'desc'));
        }

        function openShopHistory() {
            toggleShopSidebar();
            document.getElementById('hist-title').innerText = "History with " + activeShop.shopName;
            renderHistoryQuery(db.collection('orders').where('customerPhone', '==', USER.phone).where('shopId', '==', activeShop.id).orderBy('timestamp', 'desc'));
        }

        function renderHistoryQuery(query) {
            document.getElementById('history-modal').classList.remove('hidden');
            document.getElementById('history-modal').style.display='flex';
            query.onSnapshot(snap => {
                const list = document.getElementById('history-list');
                list.innerHTML = snap.docs.map(doc => {
                    const d = doc.data();
                    const isLive = ['pending','cooking','ready'].includes(d.status);
                    return `
                    <div class="shop-card ${isLive?'border-l-4 border-orange-500':''}">
                        <div class="flex justify-between mb-2">
                            <span class="text-xs text-gray-400">${new Date(d.timestamp?.toDate()).toLocaleDateString()}</span>
                            <span class="text-[10px] uppercase font-bold ${isLive?'text-orange-400 animate-pulse':'text-gray-500'}">${d.status}</span>
                        </div>
                        <p class="text-white font-bold text-sm mb-1">${d.items.map(i=>i.name).join(', ')}</p>
                        <div class="flex justify-between items-center">
                            <span class="text-orange-500 font-bold">‚Çπ${d.totalAmount}</span>
                            ${d.status==='pending' ? `<button onclick="db.collection('orders').doc('${doc.id}').update({status:'cancelled'})" class="text-red-500 text-xs border border-red-500 px-2 py-1 rounded">Cancel</button>` : ''}
                        </div>
                    </div>`;
                }).join('');
            });
        }

        // Chat
        function openChat() {
            toggleShopSidebar();
            document.getElementById('chat-modal').classList.remove('hidden');
            document.getElementById('chat-modal').style.display='flex';
            db.collection('shops').doc(activeShop.id).collection('chats').doc(USER.phone).collection('messages').orderBy('timestamp').onSnapshot(snap => {
                document.getElementById('chat-box').innerHTML = snap.docs.map(d => `<div class="chat-bubble ${d.data().sender==='user'?'msg-me':'msg-other'}">${d.data().text}</div>`).join('');
            });
        }
        function sendChat() {
            const t = document.getElementById('chat-msg').value.trim();
            if(t && activeShop) {
                const ref = db.collection('shops').doc(activeShop.id).collection('chats').doc(USER.phone);
                ref.collection('messages').add({text:t, sender:'user', timestamp: firebase.firestore.FieldValue.serverTimestamp()});
                ref.set({lastMsg: t, timestamp: firebase.firestore.FieldValue.serverTimestamp()}, {merge:true});
                document.getElementById('chat-msg').value='';
            }
        }

        // Utils
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; 
        }
        function shareApp() { navigator.share({title: 'Nearby Bazar', text: 'Order food online!', url: window.location.href}); }
    </script>
</body>
</html>
