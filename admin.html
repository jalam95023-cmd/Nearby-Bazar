<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin - Nearby Bazar</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --accent: #6366f1; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; }
        
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .status-badge { padding: 4px 12px; border-radius: 99px; font-size: 10px; font-weight: 800; text-transform: uppercase; }
        .badge-pending { background: rgba(245, 158, 11, 0.1); color: #fbbf24; border: 1px solid rgba(245, 158, 11, 0.2); animation: pulse 2s infinite; }
        .badge-verified { background: rgba(16, 185, 129, 0.1); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.2); }
        .badge-suspended { background: rgba(239, 68, 68, 0.1); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.2); }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    </style>
</head>
<body class="p-6 max-w-7xl mx-auto">

    <div class="flex justify-between items-center mb-8 border-b border-gray-800 pb-4">
        <div>
            <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-cyan-400">Nearby Bazar</h1>
            <p class="text-xs text-gray-500 tracking-widest uppercase font-bold mt-1">Super Admin Console</p>
        </div>
        <div class="flex gap-4">
            <div class="text-right">
                <p class="text-xs text-gray-400">Total Revenue</p>
                <h2 class="text-xl font-bold text-green-400">â‚¹<span id="st-revenue">0</span></h2>
            </div>
            <div class="text-right">
                <p class="text-xs text-gray-400">Active Shops</p>
                <h2 class="text-xl font-bold text-blue-400" id="st-active">0</h2>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        <div>
            <div class="flex items-center gap-2 mb-4">
                <div class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></div>
                <h3 class="text-xl font-bold text-white">Pending Approvals</h3>
            </div>
            
            <div id="pending-list" class="space-y-3">
                <div class="text-center py-10 text-gray-600 bg-gray-800/30 rounded-xl border border-gray-800 border-dashed">
                    <i class="fas fa-check-circle text-2xl mb-2"></i>
                    <p class="text-sm">All caught up! No pending requests.</p>
                </div>
            </div>
        </div>

        <div>
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-white">Live Shops</h3>
                <input type="text" onkeyup="filterShops(this.value)" placeholder="Search Shop..." class="bg-gray-800 border border-gray-700 text-xs text-white px-4 py-2 rounded-full outline-none focus:border-indigo-500">
            </div>

            <div id="shops-list" class="space-y-2 h-[600px] overflow-y-auto pr-2">
                <p class="text-center text-gray-600 text-sm py-10">Loading Data...</p>
            </div>
        </div>

    </div>

    <script type="module">
        // --- USING NEARBY BAZAR API KEY (CORRECT ONE) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyDm_yS9tmdfnMmhoUiGwLSAnQpz5trXuko", 
            authDomain: "nearby-bazar.firebaseapp.com", 
            projectId: "nearby-bazar", 
            storageBucket: "nearby-bazar.firebasestorage.app", 
            messagingSenderId: "183262510084", 
            appId: "1:183262510084:web:909fa3aac2f2429a7d8951" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- 1. REALTIME LISTENER ---
        onSnapshot(collection(db, "shops"), (snap) => {
            const pendingDiv = document.getElementById('pending-list');
            const activeDiv = document.getElementById('shops-list');
            
            let pendingHTML = "";
            let activeHTML = "";
            let stats = { revenue: 0, active: 0 };

            if(snap.empty) {
                activeDiv.innerHTML = "<p class='text-center text-gray-600 py-4'>No shops found.</p>";
                return;
            }

            snap.forEach(docSnap => {
                const s = docSnap.data();
                const id = docSnap.id;

                // Pending Card
                if(s.status === 'pending') {
                    pendingHTML += `
                    <div class="glass-panel !p-5 border-l-4 border-yellow-500 relative">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-bold text-lg text-white">${s.shopName}</h4>
                                <p class="text-xs text-gray-400"><i class="fas fa-user mr-1"></i> ${s.ownerName}</p>
                            </div>
                            <span class="badge-pending">NEW</span>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-xs text-gray-300 font-mono bg-black/20 p-2 rounded mb-3">
                            <span>ðŸ“± ${s.phone}</span>
                            <span>ðŸ’³ ${s.upiId}</span>
                            <span class="col-span-2">ID: ${s.shopId}</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="window.decision('${id}', 'verified')" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg text-xs font-bold transition shadow-lg shadow-green-900/20">APPROVE</button>
                            <button onclick="window.decision('${id}', 'rejected')" class="flex-1 bg-gray-700 hover:bg-red-600 text-white py-2 rounded-lg text-xs font-bold transition">REJECT</button>
                        </div>
                    </div>`;
                } 
                // Active Card
                else {
                    if(s.status === 'verified') stats.active++;
                    const isSuspended = s.status === 'suspended';
                    
                    activeHTML += `
                    <div class="glass-panel !p-3 flex justify-between items-center shop-card hover:bg-gray-800/50 transition" data-name="${s.shopName.toLowerCase()}">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center text-orange-500 font-bold text-sm border border-gray-600">
                                ${s.shopName.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <h4 class="font-bold text-sm text-white ${isSuspended ? 'line-through text-gray-500' : ''}">${s.shopName}</h4>
                                <p class="text-[10px] text-gray-400 font-mono">ID: ${s.shopId}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="status-badge ${isSuspended ? 'badge-suspended' : 'badge-verified'} block w-fit ml-auto mb-1">
                                ${isSuspended ? 'BANNED' : 'ACTIVE'}
                            </span>
                            <button onclick="window.toggleBan('${id}', ${isSuspended})" class="text-[10px] text-gray-400 hover:text-white underline">
                                ${isSuspended ? 'Unban' : 'Suspend'}
                            </button>
                        </div>
                    </div>`;
                }
            });

            if(pendingHTML) pendingDiv.innerHTML = pendingHTML;
            else pendingDiv.innerHTML = `<div class="text-center py-10 text-gray-600 bg-gray-800/30 rounded-xl border border-gray-800 border-dashed"><i class="fas fa-check-circle text-2xl mb-2"></i><p class="text-sm">All caught up!</p></div>`;
            
            activeDiv.innerHTML = activeHTML;
            document.getElementById('st-active').innerText = stats.active;
        });

        // --- 2. GLOBAL ACTIONS ---
        window.decision = async (id, status) => {
            const action = status === 'verified' ? 'Approve' : 'Reject';
            
            // SweetAlert Popup
            const result = await Swal.fire({
                title: `${action} Shop?`,
                text: status === 'verified' ? "Shop will go live immediately." : "This request will be deleted.",
                icon: status === 'verified' ? 'question' : 'warning',
                showCancelButton: true,
                confirmButtonColor: status === 'verified' ? '#10b981' : '#ef4444',
                confirmButtonText: `Yes, ${action}`,
                background: '#1e293b',
                color: '#fff'
            });

            if(result.isConfirmed) {
                if(status === 'rejected') {
                    await deleteDoc(doc(db, "shops", id));
                    Swal.fire({title: "Deleted", icon: "success", background: '#1e293b', color: '#fff', timer: 1500, showConfirmButton: false});
                } else {
                    await updateDoc(doc(db, "shops", id), { status: 'verified', isOpen: true });
                    Swal.fire({title: "Approved!", icon: "success", background: '#1e293b', color: '#fff', timer: 1500, showConfirmButton: false});
                }
            }
        };

        window.toggleBan = async (id, isSuspended) => {
            const newStatus = isSuspended ? 'verified' : 'suspended';
            await updateDoc(doc(db, "shops", id), { status: newStatus, isOpen: isSuspended }); // Force close if suspended
            const msg = isSuspended ? "Shop Unbanned" : "Shop Suspended";
            Swal.fire({title: msg, icon: "info", background: '#1e293b', color: '#fff', timer: 1000, showConfirmButton: false});
        };

        window.filterShops = (val) => {
            document.querySelectorAll('.shop-card').forEach(el => {
                el.style.display = el.getAttribute('data-name').includes(val.toLowerCase()) ? 'flex' : 'none';
            });
        };
    </script>
</body>
</html>
