<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SuperAdmin - Nearby Bazar</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Dark Theme - SGMC Aesthetic */
        :root { --bg: #0f0f0f; --card: #1a1a1a; --text: #fff; --accent: #6366f1; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; }
        
        .glass-panel {
            background: rgba(30, 30, 30, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(145deg, #1e1e1e, #252525);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid var(--accent);
        }

        .status-badge { padding: 4px 10px; border-radius: 50px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
        .badge-pending { background: #f59e0b20; color: #f59e0b; border: 1px solid #f59e0b50; }
        .badge-verified { background: #10b98120; color: #10b981; border: 1px solid #10b98150; }
        .badge-suspended { background: #ef444420; color: #ef4444; border: 1px solid #ef444450; }

        /* Action Buttons */
        .btn-icon { width: 35px; height: 35px; border-radius: 8px; display: inline-flex; align-items: center; justify-content: center; transition: 0.2s; cursor: pointer; }
        .btn-approve { background: #10b981; color: white; }
        .btn-reject { background: #ef4444; color: white; }
        .btn-suspend { background: #333; color: #ef4444; border: 1px solid #ef4444; }
    </style>
</head>
<body class="p-4 max-w-6xl mx-auto">

    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-purple-500">Nearby Bazar</h1>
            <p class="text-xs text-gray-500 tracking-widest uppercase">Super Admin Console</p>
        </div>
        <div class="text-right">
            <p class="text-xs text-green-400 font-bold">● SYSTEM ONLINE</p>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="stat-card border-indigo-500">
            <p class="text-gray-400 text-xs uppercase">Total Revenue</p>
            <h2 class="text-2xl font-bold">₹<span id="st-revenue">0</span></h2>
        </div>
        <div class="stat-card border-green-500">
            <p class="text-gray-400 text-xs uppercase">Active Shops</p>
            <h2 class="text-2xl font-bold" id="st-active">0</h2>
        </div>
        <div class="stat-card border-yellow-500">
            <p class="text-gray-400 text-xs uppercase">Pending Approval</p>
            <h2 class="text-2xl font-bold" id="st-pending">0</h2>
        </div>
        <div class="stat-card border-red-500">
            <p class="text-gray-400 text-xs uppercase">Global Users</p>
            <h2 class="text-2xl font-bold" id="st-users">0</h2>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        <div>
            <h3 class="text-xl font-bold mb-4 text-yellow-500"><i class="fas fa-clock mr-2"></i> Pending Approvals</h3>
            <div id="pending-container" class="space-y-3">
                <p class="text-center text-gray-600 text-sm py-4">No new applications.</p>
            </div>
        </div>

        <div>
            <h3 class="text-xl font-bold mb-4 text-green-500"><i class="fas fa-store mr-2"></i> Live Shops</h3>
            <input type="text" id="search-shop" placeholder="Search Shop Name or ID..." class="w-full bg-[#1a1a1a] border border-[#333] text-white p-3 rounded-xl mb-4 text-sm outline-none focus:border-indigo-500" onkeyup="filterShops(this.value)">
            <div id="shops-container" class="space-y-3 max-h-[600px] overflow-y-auto pr-2">
                <p class="text-center text-gray-600 text-sm py-4">Loading Shops...</p>
            </div>
        </div>

    </div>

    <button onclick="sendBroadcast()" class="fixed bottom-8 right-8 bg-indigo-600 hover:bg-indigo-700 text-white p-4 rounded-full shadow-2xl transition-transform hover:scale-110">
        <i class="fas fa-bullhorn text-xl"></i>
    </button>

    <script type="module">
        // --- NEARBY BAZAR CONFIG ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyDm_yS9tmdfnMmhoUiGwLSAnQpz5trXuko", 
            authDomain: "nearby-bazar.firebaseapp.com", 
            projectId: "nearby-bazar", 
            storageBucket: "nearby-bazar.firebasestorage.app", 
            messagingSenderId: "183262510084", 
            appId: "1:183262510084:web:909fa3aac2f2429a7d8951" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- 1. LISTEN TO SHOPS ---
        onSnapshot(collection(db, "shops"), (snap) => {
            const pendingDiv = document.getElementById("pending-container");
            const activeDiv = document.getElementById("shops-container");
            
            let pendingHTML = "";
            let activeHTML = "";
            
            let pendingCount = 0;
            let activeCount = 0;

            snap.forEach(docSnap => {
                const s = docSnap.data();
                const id = docSnap.id;

                // --- PENDING REQUESTS ---
                if(s.status === 'pending') {
                    pendingCount++;
                    pendingHTML += `
                    <div class="glass-panel !p-4 flex flex-col gap-2">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-lg">${s.shopName}</h4>
                                <p class="text-xs text-gray-400">Owner: ${s.ownerName}</p>
                                <p class="text-xs text-gray-400">Phone: ${s.phone}</p>
                                <p class="text-xs text-indigo-400 font-mono mt-1">UPI: ${s.upiId || 'N/A'}</p>
                            </div>
                            <span class="badge-pending">New Request</span>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <button onclick="window.processShop('${id}', 'verified')" class="flex-1 bg-green-600/20 text-green-400 border border-green-600/50 py-2 rounded-lg text-xs font-bold hover:bg-green-600 hover:text-white transition">APPROVE</button>
                            <button onclick="window.processShop('${id}', 'rejected')" class="flex-1 bg-red-600/20 text-red-400 border border-red-600/50 py-2 rounded-lg text-xs font-bold hover:bg-red-600 hover:text-white transition">REJECT</button>
                        </div>
                    </div>`;
                } 
                // --- ACTIVE/SUSPENDED SHOPS ---
                else if (s.status === 'verified' || s.status === 'suspended') {
                    if(s.status === 'verified') activeCount++;
                    const isSuspended = s.status === 'suspended';
                    
                    activeHTML += `
                    <div class="glass-panel !p-4 shop-card" data-name="${s.shopName.toLowerCase()}">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-bold text-lg ${isSuspended ? 'text-gray-500 line-through' : 'text-white'}">${s.shopName}</h4>
                            <span class="status-badge ${isSuspended ? 'badge-suspended' : 'badge-verified'}">
                                ${isSuspended ? 'SUSPENDED' : 'LIVE'}
                            </span>
                        </div>
                        <div class="flex justify-between items-end">
                            <div class="text-xs text-gray-400">
                                <p>ID: <span class="text-gray-200 select-all">${id}</span></p>
                                <p>UPI: ${s.upiId}</p>
                            </div>
                            <button onclick="window.toggleSuspend('${id}', ${isSuspended})" class="text-xs font-bold px-3 py-1 rounded border ${isSuspended ? 'border-green-500 text-green-500 hover:bg-green-500 hover:text-white' : 'border-red-500 text-red-500 hover:bg-red-500 hover:text-white'} transition">
                                ${isSuspended ? 'ACTIVATE' : 'KILL SWITCH'}
                            </button>
                        </div>
                    </div>`;
                }
            });

            if(pendingHTML) pendingDiv.innerHTML = pendingHTML;
            else pendingDiv.innerHTML = '<p class="text-center text-gray-600 text-sm py-4">No pending verifications.</p>';

            if(activeHTML) activeDiv.innerHTML = activeHTML;
            else activeDiv.innerHTML = '<p class="text-center text-gray-600 text-sm py-4">No active shops found.</p>';

            // Update Stats
            document.getElementById("st-active").innerText = activeCount;
            document.getElementById("st-pending").innerText = pendingCount;
        });

        // --- 2. STATS AGGREGATION (Revenue & Users) ---
        // Listening to ALL orders to calculate total platform revenue
        onSnapshot(collection(db, "orders"), (snap) => {
            let totalRevenue = 0;
            let uniqueUsers = new Set();

            snap.forEach(d => {
                const o = d.data();
                // Revenue Calculation (Only delivered or completed orders)
                if(o.status === 'delivered' || o.status === 'completed') {
                    totalRevenue += (parseInt(o.totalAmount) || 0);
                }
                // User Counting
                if(o.customerPhone) uniqueUsers.add(o.customerPhone);
            });

            document.getElementById("st-revenue").innerText = totalRevenue.toLocaleString();
            document.getElementById("st-users").innerText = uniqueUsers.size;
        });

        // --- 3. ACTIONS ---

        // Approve or Reject Shop
        window.processShop = async (id, status) => {
            const action = status === 'verified' ? 'Approve' : 'Reject';
            const result = await Swal.fire({
                title: `${action} Shop?`,
                text: "Confirm this action.",
                icon: status === 'verified' ? 'success' : 'warning',
                showCancelButton: true,
                confirmButtonColor: status === 'verified' ? '#10b981' : '#ef4444',
                confirmButtonText: `Yes, ${action}`
            });

            if (result.isConfirmed) {
                if(status === 'rejected') {
                    // Delete the document if rejected to clean up
                    await deleteDoc(doc(db, "shops", id));
                    Swal.fire("Deleted", "Shop application rejected.", "info");
                } else {
                    // Update status to verified
                    await updateDoc(doc(db, "shops", id), { status: 'verified', isOpen: true });
                    Swal.fire("Success", "Shop is now LIVE!", "success");
                }
            }
        };

        // Kill Switch (Suspend Shop)
        window.toggleSuspend = async (id, isCurrentlySuspended) => {
            if(!isCurrentlySuspended) {
                const confirm = await Swal.fire({
                    title: 'Are you sure?',
                    text: "This will immediately block the shop owner and customers won't see this shop.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#ef4444',
                    confirmButtonText: 'Yes, Kill it!'
                });
                if(!confirm.isConfirmed) return;
            }

            const newStatus = isCurrentlySuspended ? 'verified' : 'suspended';
            // Also force 'isOpen' to false if suspended
            await updateDoc(doc(db, "shops", id), { 
                status: newStatus,
                isOpen: isCurrentlySuspended ? true : false 
            });
            
            const msg = isCurrentlySuspended ? "Shop Reactivated" : "Shop Suspended";
            const icon = isCurrentlySuspended ? "success" : "error";
            Swal.fire(msg, "", icon);
        };

        // Broadcast Message
        window.sendBroadcast = async () => {
            const { value: text } = await Swal.fire({
                title: 'Global Broadcast',
                input: 'textarea',
                inputLabel: 'Message to all Customer Apps',
                inputPlaceholder: 'e.g. Server maintenance at 10 PM...',
                showCancelButton: true
            });

            if (text) {
                // Assuming we store global config in a separate doc or collection
                // For now, let's just log it or update a 'system' collection
                // Ideally, you'd update a document that all User Apps listen to.
                // Creating a 'system/config' doc if it doesn't exist
                await updateDoc(doc(db, "system", "config"), { broadcastMessage: text })
                    .catch(() => {
                        // Create if not exists
                        // Note: Using setDoc logic would need import, assuming 'system' exists for now or error handling
                        console.log("Broadcast logic placeholder - requires 'system' collection setup");
                    });
                Swal.fire('Sent!', 'Broadcast queued.', 'success');
            }
        };

        // Filter Function for Search
        window.filterShops = (val) => {
            const items = document.querySelectorAll('.shop-card');
            items.forEach(item => {
                const name = item.getAttribute('data-name');
                if(name.includes(val.toLowerCase())) item.style.display = 'block';
                else item.style.display = 'none';
            });
        };

    </script>
</body>
</html>
