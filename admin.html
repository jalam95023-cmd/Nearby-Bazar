<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Super Admin • Nearby Bazar</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f0f0f">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root { --bg: #0f0f0f; --card: #1a1a1a; --border: #333; --accent: #F97316; --text: #fff; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; padding-bottom: 80px; }
        
        .screen { position: fixed; inset: 0; background: var(--bg); z-index: 10; display: none; flex-direction: column; overflow-y: auto; }
        .screen.active { display: flex; }
        
        .glass-header { position: sticky; top: 0; background: rgba(15, 15, 15, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); padding: 16px; z-index: 50; display: flex; justify-content: space-between; align-items: center; }
        
        .stat-card { background: var(--card); border: 1px solid var(--border); padding: 16px; border-radius: 16px; position: relative; overflow: hidden; }
        .stat-card::after { content:''; position:absolute; top:0; right:0; width:50px; height:50px; background:linear-gradient(135deg, transparent 50%, rgba(249, 115, 22, 0.1)); }
        
        .list-item { background: var(--card); margin-bottom: 10px; padding: 16px; border-radius: 12px; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        
        /* Sidebar */
        .sidebar { position: fixed; top: 0; left: 0; bottom: 0; width: 280px; background: #111; z-index: 200; transform: translateX(-100%); transition: 0.3s; border-right: 1px solid var(--border); }
        .sidebar.open { transform: translateX(0); }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 150; display: none; }
        .overlay.open { display: block; }
        
        .menu-btn { width: 40px; height: 40px; border-radius: 10px; background: #222; color: white; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="scr-auth" class="screen active justify-center p-6">
        <div class="text-center mb-10">
            <div class="w-20 h-20 bg-orange-600 rounded-2xl mx-auto mb-4 flex items-center justify-center text-3xl text-white font-bold shadow-lg shadow-orange-900/50">NB</div>
            <h1 class="text-3xl font-bold text-white mb-1">Super Admin</h1>
            <p class="text-xs text-gray-500 uppercase tracking-widest">Nearby Bazar Control</p>
        </div>
        <div class="bg-[#1a1a1a] p-6 rounded-2xl border border-[#333]">
            <input type="text" id="adm-user" placeholder="Username" class="w-full bg-[#222] border border-[#333] p-3 rounded-xl text-white mb-3 outline-none focus:border-orange-500">
            <input type="password" id="adm-pass" placeholder="Password" class="w-full bg-[#222] border-[#333] border p-3 rounded-xl text-white mb-6 outline-none focus:border-orange-500">
            <button onclick="login()" class="w-full bg-gradient-to-r from-orange-600 to-red-600 text-white font-bold py-3.5 rounded-xl shadow-lg active:scale-95 transition">SECURE LOGIN</button>
        </div>
    </div>

    <div id="scr-home" class="screen p-6 pt-20">
        <div class="text-center mb-12">
            <h2 class="text-3xl font-bold text-white mb-1">Welcome, Boss</h2>
            <p class="text-gray-500 text-sm">Select a module to manage</p>
        </div>
        
        <div onclick="openDashboard('shops')" class="bg-[#1a1a1a] border border-[#333] p-6 rounded-2xl mb-4 flex items-center gap-4 cursor-pointer hover:border-orange-500 transition active:scale-95">
            <div class="w-14 h-14 rounded-full bg-blue-500/10 text-blue-500 flex items-center justify-center text-2xl"><i class="fas fa-store"></i></div>
            <div><h3 class="font-bold text-lg text-white">Manage Shops</h3><p class="text-xs text-gray-400">Approvals, Revenue, Settings</p></div>
            <i class="fas fa-chevron-right ml-auto text-gray-600"></i>
        </div>

        <div onclick="openDashboard('users')" class="bg-[#1a1a1a] border border-[#333] p-6 rounded-2xl mb-4 flex items-center gap-4 cursor-pointer hover:border-green-500 transition active:scale-95">
            <div class="w-14 h-14 rounded-full bg-green-500/10 text-green-500 flex items-center justify-center text-2xl"><i class="fas fa-users"></i></div>
            <div><h3 class="font-bold text-lg text-white">Manage Users</h3><p class="text-xs text-gray-400">Database, History, Support</p></div>
            <i class="fas fa-chevron-right ml-auto text-gray-600"></i>
        </div>

        <button onclick="installApp()" id="install-btn" class="hidden mt-8 w-full bg-[#222] text-white py-3 rounded-xl border border-[#333] flex items-center justify-center gap-2"><i class="fas fa-download"></i> Install App</button>
        
        <button onclick="logout()" class="mt-4 text-red-500 text-sm font-bold flex items-center justify-center gap-2 w-full py-3"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>

    <div id="scr-shops" class="screen">
        <div class="glass-header">
            <button onclick="toggleSidebar()" class="menu-btn"><i class="fas fa-bars"></i></button>
            <h2 class="text-lg font-bold text-white">Shop Manager</h2>
            <button onclick="showScreen('scr-home')" class="menu-btn"><i class="fas fa-home"></i></button>
        </div>

        <div class="grid grid-cols-2 gap-3 p-4">
            <div class="stat-card">
                <p class="text-[10px] text-gray-500 uppercase font-bold">Active</p>
                <h2 class="text-2xl font-bold text-white mt-1" id="cnt-active">0</h2>
            </div>
            <div class="stat-card">
                <p class="text-[10px] text-gray-500 uppercase font-bold">Pending</p>
                <h2 class="text-2xl font-bold text-yellow-500 mt-1" id="cnt-pending">0</h2>
            </div>
        </div>

        <div class="p-4 pt-0">
            <h3 class="font-bold text-white text-lg mb-4">All Shops</h3>
            <div id="shop-list" class="space-y-2"></div>
        </div>
    </div>

    <div id="scr-users" class="screen">
        <div class="glass-header">
            <button onclick="toggleSidebar()" class="menu-btn"><i class="fas fa-bars"></i></button>
            <h2 class="text-lg font-bold text-white">User Manager</h2>
            <button onclick="showScreen('scr-home')" class="menu-btn"><i class="fas fa-home"></i></button>
        </div>

        <div class="grid grid-cols-2 gap-3 p-4">
            <div class="stat-card">
                <p class="text-[10px] text-gray-500 uppercase font-bold">Total Users</p>
                <h2 class="text-2xl font-bold text-white mt-1" id="cnt-users">0</h2>
            </div>
            <div class="stat-card">
                <p class="text-[10px] text-gray-500 uppercase font-bold">Today Active</p>
                <h2 class="text-2xl font-bold text-green-500 mt-1" id="cnt-active-users">0</h2>
            </div>
        </div>

        <div class="p-4 pt-0">
            <h3 class="font-bold text-white text-lg mb-4">User Database</h3>
            <div id="user-list" class="space-y-2"></div>
        </div>
    </div>

    <div id="overlay" class="overlay" onclick="toggleSidebar()"></div>
    <div id="sidebar" class="sidebar p-6 flex flex-col">
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-orange-500">Nearby Bazar</h2>
            <p class="text-xs text-gray-500">Admin Control</p>
        </div>
        <div class="space-y-4 flex-1">
            <button onclick="showScreen('scr-shops'); toggleSidebar()" class="text-gray-300 font-bold flex items-center gap-3"><i class="fas fa-store w-6"></i> Shops</button>
            <button onclick="showScreen('scr-users'); toggleSidebar()" class="text-gray-300 font-bold flex items-center gap-3"><i class="fas fa-users w-6"></i> Users</button>
            <button onclick="alert('Settings coming soon')" class="text-gray-300 font-bold flex items-center gap-3"><i class="fas fa-cog w-6"></i> Settings</button>
        </div>
        <button onclick="logout()" class="text-red-500 font-bold flex items-center gap-3"><i class="fas fa-sign-out-alt w-6"></i> Logout</button>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBadYpoNTL0dHkBQO4UddRVtPIfUOlf-bA", authDomain: "nearby-bazar.firebaseapp.com", projectId: "nearby-bazar", storageBucket: "nearby-bazar.firebasestorage.app", messagingSenderId: "183262510084", appId: "1:183262510084:web:85d9a50a3b51b30aae351f", measurementId: "G-4996NPF55N" };
        firebase.initializeApp(firebaseConfig); const db = firebase.firestore();

        // Admin Credentials
        const ADM_USER = "admin"; const ADM_PASS = "admin@nearby123";
        let deferredPrompt;

        // --- AUTH ---
        if(localStorage.getItem('nb_admin_auth')) showScreen('scr-home');

        function login() {
            if(document.getElementById('adm-user').value === ADM_USER && document.getElementById('adm-pass').value === ADM_PASS) {
                localStorage.setItem('nb_admin_auth', 'true'); showScreen('scr-home');
            } else Swal.fire("Error", "Invalid Credentials", "error");
        }
        function logout() { localStorage.removeItem('nb_admin_auth'); location.reload(); }

        // --- NAVIGATION ---
        function showScreen(id) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('overlay').classList.toggle('open'); }
        
        function openDashboard(type) {
            if(type === 'shops') { showScreen('scr-shops'); loadShops(); }
            if(type === 'users') { showScreen('scr-users'); loadUsers(); }
        }

        // --- SHOPS LOGIC ---
        function loadShops() {
            db.collection('shops').onSnapshot(snap => {
                const list = document.getElementById('shop-list');
                let active=0, pending=0;
                list.innerHTML = "";
                
                snap.forEach(doc => {
                    const s = doc.data();
                    if(s.status === 'verified') active++; else if(s.status === 'pending') pending++;
                    
                    list.innerHTML += `
                    <div class="list-item">
                        <div>
                            <h4 class="font-bold text-white">${s.shopName}</h4>
                            <p class="text-xs text-gray-500">${s.ownerName} • ${s.phone}</p>
                        </div>
                        <div>
                            ${s.status === 'pending' ? 
                                `<button onclick="approveShop('${doc.id}')" class="bg-green-600 text-white text-xs px-3 py-1 rounded">Approve</button>` : 
                                `<span class="text-green-500 text-xs font-bold uppercase">${s.status}</span>`}
                        </div>
                    </div>`;
                });
                
                document.getElementById('cnt-active').innerText = active;
                document.getElementById('cnt-pending').innerText = pending;
            });
        }

        function approveShop(id) {
            db.collection('shops').doc(id).update({status: 'verified', isOpen: true});
        }

        // --- USERS LOGIC ---
        function loadUsers() {
            // Since we don't have a dedicated 'users' collection yet (users are in localStorage of customers),
            // we will fetch unique users from the 'orders' collection for now.
            db.collection('orders').orderBy('timestamp', 'desc').limit(50).onSnapshot(snap => {
                const list = document.getElementById('user-list');
                const users = new Set();
                list.innerHTML = "";
                
                snap.forEach(doc => {
                    const o = doc.data();
                    if(!users.has(o.customerPhone)) {
                        users.add(o.customerPhone);
                        list.innerHTML += `
                        <div class="list-item">
                            <div>
                                <h4 class="font-bold text-white">${o.customerName}</h4>
                                <p class="text-xs text-gray-500">${o.customerPhone}</p>
                            </div>
                            <span class="text-xs bg-gray-800 text-gray-400 px-2 py-1 rounded">Last Order: ₹${o.totalAmount}</span>
                        </div>`;
                    }
                });
                
                document.getElementById('cnt-users').innerText = users.size;
                document.getElementById('cnt-active-users').innerText = Math.floor(users.size * 0.4); // Mock active count
            });
        }

        // --- PWA INSTALL ---
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-btn').classList.remove('hidden');
        });

        async function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    deferredPrompt = null;
                    document.getElementById('install-btn').classList.add('hidden');
                }
            }
        }
    </script>
</body>
</html>
