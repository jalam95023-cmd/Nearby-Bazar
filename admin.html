<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nearby Bazar - Super Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { background-color: #f8f9fa; }
        .sidebar { min-height: 100vh; background: #343a40; color: white; }
        .nav-link { color: rgba(255,255,255,.8); margin-bottom: 10px; }
        .nav-link:hover, .nav-link.active { color: #fff; background: rgba(255,255,255,.1); border-radius: 5px; }
        .card-stat { border: none; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        #map { height: 400px; width: 100%; border-radius: 10px; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <nav class="col-md-2 d-none d-md-block sidebar p-3">
            <h4 class="mb-4">‚ö° Super Admin</h4>
            <ul class="nav flex-column">
                <li class="nav-item"><a class="nav-link active" href="#" onclick="showSection('dashboard')">üìä Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('approvals')">‚úÖ Approvals <span id="pending-count" class="badge bg-danger float-end">0</span></a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('shops')">Bm Shops Database</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('users')">üë• Users</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('settings')">‚öôÔ∏è Settings</a></li>
            </ul>
        </nav>

        <main class="col-md-10 ms-sm-auto px-md-4 py-4">
            
            <div id="dashboard">
                <h2 class="mb-4">Overview</h2>
                <div class="row mb-4">
                    <div class="col-md-3"><div class="card card-stat p-3 bg-white"><h5>Total Shops</h5><h2 id="total-shops">0</h2></div></div>
                    <div class="col-md-3"><div class="card card-stat p-3 bg-white"><h5>Active Users</h5><h2 id="total-users">0</h2></div></div>
                    <div class="col-md-3"><div class="card card-stat p-3 bg-white"><h5>Pending Req.</h5><h2 id="total-pending" class="text-danger">0</h2></div></div>
                    <div class="col-md-3"><div class="card card-stat p-3 bg-white"><h5>Revenue</h5><h2 class="text-success">‚Çπ0</h2></div></div>
                </div>
                
                <div class="card card-stat p-3 mb-4">
                    <h5>üìç Live Market Map</h5>
                    <div id="map"></div>
                </div>
            </div>

            <div id="approvals" style="display:none;">
                <h2>Pending Approvals</h2>
                <div class="table-responsive bg-white p-3 rounded shadow-sm">
                    <table class="table">
                        <thead><tr><th>Shop Name</th><th>Owner</th><th>Phone</th><th>Aadhar</th><th>Action</th></tr></thead>
                        <tbody id="approval-list">
                            </tbody>
                    </table>
                </div>
            </div>

             <div id="shops" style="display:none;">
                <h2>All Shops</h2>
                <div class="table-responsive bg-white p-3 rounded shadow-sm">
                    <table class="table">
                        <thead><tr><th>Shop Name</th><th>Status</th><th>Wallet</th><th>Action</th></tr></thead>
                        <tbody id="all-shops-list"></tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDm_yS9tmdfnMmhoUiGwLSAnQpz5trXuko",
        authDomain: "nearby-bazar.firebaseapp.com",
        projectId: "nearby-bazar",
        storageBucket: "nearby-bazar.firebasestorage.app",
        messagingSenderId: "183262510084",
        appId: "1:183262510084:web:909fa3aac2f2429a7d8951"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- Map Setup ---
    var map = L.map('map').setView([20.5937, 78.9629], 5); // India Center
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // --- Realtime Data Listeners ---
    
    // 1. Fetch Shops (Pending & Active)
    const shopsCol = collection(db, "shops");
    onSnapshot(shopsCol, (snapshot) => {
        let total = 0, pending = 0;
        let approvalHtml = "", allShopsHtml = "";
        
        // Clear Map Markers
        map.eachLayer((layer) => { if(layer instanceof L.Marker) map.removeLayer(layer); });

        snapshot.forEach((docSnap) => {
            const data = docSnap.data();
            const id = docSnap.id;
            total++;

            // Map Marker for Active Shops
            if(data.status === "verified" && data.lat && data.lng) {
                L.marker([data.lat, data.lng]).addTo(map).bindPopup(`<b>${data.shopName}</b><br>${data.ownerName}`);
            }

            // Lists Logic
            if(data.status === "pending") {
                pending++;
                approvalHtml += `<tr>
                    <td>${data.shopName}</td>
                    <td>${data.ownerName}</td>
                    <td>${data.phone}</td>
                    <td><a href="#" onclick="alert('Aadhar Link: ${data.aadharUrl}')">View ID</a></td>
                    <td>
                        <button class="btn btn-success btn-sm" onclick="approveShop('${id}')">Approve</button>
                        <button class="btn btn-danger btn-sm" onclick="rejectShop('${id}')">Reject</button>
                    </td>
                </tr>`;
            }

            allShopsHtml += `<tr>
                <td>${data.shopName}</td>
                <td><span class="badge bg-${data.status=='verified'?'success':'warning'}">${data.status}</span></td>
                <td>‚Çπ${data.wallet || 0}</td>
                <td><button class="btn btn-dark btn-sm" onclick="toggleSuspend('${id}', '${data.status}')">${data.status=='suspended'?'Unban':'Ban'}</button></td>
            </tr>`;
        });

        document.getElementById("total-shops").innerText = total;
        document.getElementById("total-pending").innerText = pending;
        document.getElementById("pending-count").innerText = pending;
        document.getElementById("approval-list").innerHTML = approvalHtml || '<tr><td colspan="5">No pending requests</td></tr>';
        document.getElementById("all-shops-list").innerHTML = allShopsHtml;
    });

    // --- Admin Actions (Global Scope) ---
    window.approveShop = async (id) => {
        if(confirm("Approve this shop?")) {
            await updateDoc(doc(db, "shops", id), { status: "verified" });
        }
    };

    window.rejectShop = async (id) => {
        if(confirm("Reject this request?")) {
            await updateDoc(doc(db, "shops", id), { status: "rejected" });
        }
    };

    window.toggleSuspend = async (id, currentStatus) => {
        const newStatus = currentStatus === 'suspended' ? 'verified' : 'suspended';
        await updateDoc(doc(db, "shops", id), { status: newStatus });
    };

    // --- Navigation Logic ---
    window.showSection = (id) => {
        ['dashboard', 'approvals', 'shops', 'users', 'settings'].forEach(s => document.getElementById(s).style.display = 'none');
        document.getElementById(id).style.display = 'block';
    }
</script>

</body>
</html>
